<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KST 이벤트 예매 시스템</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Paperlogy Web Font -->
    <link href="https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/Paperlogy.css" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, runTransaction, FieldValue, serverTimestamp, getDocs, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope for use in the script tag
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, runTransaction, FieldValue, serverTimestamp, getDocs, limit, orderBy
        };
    </script>

    <style>
        /* Custom Styles & Font Setup */
        :root {
            --primary-color: #3b82f6; /* Tailwind blue-500 */
            --paperlogy: 'Paperlogy', sans-serif;
            --inter: 'Inter', sans-serif;
        }

        body {
            font-family: var(--inter);
            background-color: #f7f7f7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header-font {
            font-family: var(--paperlogy);
            font-weight: 700;
        }

        .container {
            max-width: 1000px;
            width: 95%;
            margin-top: 20px;
            padding: 1rem;
        }

        /* Custom scrollbar for better feel */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .seat.reserved {
            background-color: #ef4444; /* Red */
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .seat.available {
            background-color: #4ade80; /* Green */
            color: #166534;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .seat.available:hover {
            background-color: #22c55e;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .seat.selected {
            background-color: var(--primary-color);
            color: white;
            border: 3px solid #3b82f6;
            transform: scale(1.1);
        }

        /* Modal backdrop for overlay */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }

        /* Hidden utility class (manual, since Tailwind's 'hidden' is sometimes overridden) */
        .is-hidden {
            display: none !important;
        }

    </style>
</head>
<body class="flex flex-col items-center p-4">

    <!-- Global Header -->
    <header class="w-full max-w-5xl py-4 flex justify-between items-center border-b-2 border-gray-300 mb-6">
        <h1 class="header-font text-3xl md:text-4xl text-gray-800">KST 예매 시스템</h1>
        <div id="auth-status" class="text-sm text-gray-500">
            <span id="user-id-display" class="font-mono text-xs hidden sm:inline-block"></span>
        </div>
    </header>

    <!-- Global Message/Loading Area -->
    <div id="global-message" class="w-full max-w-5xl p-3 mb-4 bg-yellow-100 text-yellow-800 border border-yellow-300 rounded-lg is-hidden" role="alert"></div>
    <div id="loading-spinner" class="is-hidden flex items-center justify-center p-4 bg-white shadow-lg rounded-lg mb-4 text-blue-500">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>데이터 로딩 중...</span>
    </div>

    <!-- Main Content Container -->
    <main id="main-content" class="container bg-white shadow-2xl rounded-xl p-6 md:p-10 transition-all duration-300">

        <!-- 1. EVENT LIST VIEW -->
        <section id="event-list-view" class="view">
            <h2 class="header-font text-2xl font-bold mb-6 text-gray-700">현재 등록된 이벤트</h2>
            <div id="events-container" class="space-y-4">
                <!-- Event cards will be injected here -->
            </div>
            <div id="no-events" class="text-center text-gray-500 p-8 border border-dashed rounded-lg is-hidden">
                현재 등록된 이벤트가 없습니다.
            </div>
        </section>

        <!-- 2. DETAIL/AUTH VIEW -->
        <section id="detail-auth-view" class="view is-hidden">
            <button onclick="changeView('event-list-view', true)" class="text-blue-500 hover:text-blue-700 mb-4 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                목록으로 돌아가기
            </button>
            
            <h2 id="detail-event-title" class="header-font text-3xl font-bold mb-4 text-gray-800"></h2>
            <p id="detail-event-desc" class="text-gray-600 mb-6"></p>

            <div id="time-status" class="p-4 rounded-lg text-center font-semibold mb-6"></div>

            <!-- Auth/Input Form -->
            <form id="user-info-form" class="space-y-4 p-6 border rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">예매자 정보 입력</h3>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">이름</label>
                    <input type="text" id="name" autocomplete="off" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="studentId" class="block text-sm font-medium text-gray-700">학번</label>
                    <input type="text" id="studentId" autocomplete="off" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">전화번호 (- 없이 11자리)</label>
                    <input type="tel" id="phone" autocomplete="off" required pattern="\d{10,11}" title="전화번호를 숫자만 입력해주세요." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="start-booking-btn" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    예매 진행하기
                </button>
                <p id="auth-error-message" class="text-red-500 text-sm is-hidden"></p>
            </form>
        </section>

        <!-- 3. BOOKING VIEW (Seats/Choices) -->
        <section id="booking-view" class="view is-hidden">
            <h2 id="booking-title" class="header-font text-3xl font-bold mb-6 text-gray-800"></h2>
            <div id="queue-info-banner" class="p-3 bg-green-100 text-green-700 border border-green-300 rounded-lg mb-4 is-hidden">
                <span class="font-semibold">예매 가능 상태:</span> 
                <span id="active-user-count"></span>명이 현재 예매 중입니다.
            </div>

            <div id="booking-content-container">
                <!-- Seats or Choices UI injected here -->
            </div>
        </section>
        
        <!-- 4. CONFIRMATION VIEW -->
        <section id="confirmation-view" class="view is-hidden text-center p-10 bg-green-50 border border-green-200 rounded-xl shadow-lg">
            <svg class="mx-auto h-12 w-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 class="header-font text-3xl font-bold mt-3 mb-4 text-green-700">예매가 완료되었습니다!</h2>
            <div id="confirmation-details" class="space-y-2 text-left inline-block p-4 border-t border-b border-green-200 bg-white rounded-lg">
                <p><span class="font-semibold">이름:</span> <span id="conf-name"></span></p>
                <p><span class="font-semibold">학번:</span> <span id="conf-studentId"></span></p>
                <p><span class="font-semibold">선택:</span> <span id="conf-selection"></span></p>
                <p><span class="font-semibold">예매번호:</span> <span id="conf-bookingNumber" class="text-lg text-red-600 font-mono"></span></p>
            </div>
            <button onclick="changeView('event-list-view', true)" class="mt-6 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                메인으로 돌아가기
            </button>
        </section>

        <!-- 5. ADMIN VIEW (Event Management) -->
        <section id="admin-view" class="view is-hidden">
            <h2 class="header-font text-3xl font-bold mb-6 text-red-600">🛠️ 관리자 모드</h2>
            <div id="admin-tools" class="space-y-8">
                <!-- Event Creation -->
                <div class="p-6 border rounded-lg shadow-md bg-gray-50">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">새 이벤트 추가</h3>
                    <form id="create-event-form" class="space-y-4">
                        <input type="text" id="admin-title" placeholder="제목" required class="w-full p-2 border rounded">
                        <textarea id="admin-description" placeholder="간략 설명" required class="w-full p-2 border rounded"></textarea>
                        
                        <select id="admin-type" required class="w-full p-2 border rounded">
                            <option value="">예매 타입 선택</option>
                            <option value="choices">선택형 (예: 1회차, 2회차)</option>
                            <option value="seats">좌석형 (예: A1, B2)</option>
                        </select>

                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700">예매 시작 (KST)</label>
                                <input type="datetime-local" id="admin-start-time" required class="w-full p-2 border rounded">
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-700">예매 종료 (KST)</label>
                                <input type="datetime-local" id="admin-end-time" required class="w-full p-2 border rounded">
                            </div>
                        </div>

                        <div id="admin-type-specific-config" class="space-y-4 p-4 border-dashed border rounded-lg is-hidden">
                            <!-- Dynamic config for seats/choices -->
                        </div>

                        <button type="submit" class="w-full py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">이벤트 생성</button>
                    </form>
                </div>
                
                <!-- Event List for Management -->
                <div class="p-6 border rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">등록된 이벤트 관리</h3>
                    <div id="admin-event-list" class="space-y-4">
                        <!-- List of events with options to manage details/bookings -->
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Global Footer Tabs -->
    <footer class="w-full max-w-5xl mt-6">
        <div class="flex border-t border-gray-300 pt-4">
            <button onclick="changeView('event-list-view', true)" class="flex-1 py-3 border-r rounded-l-lg font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 transition">
                🏠 메인 화면
            </button>
            <button onclick="changeView('my-booking-view', true)" class="flex-1 py-3 rounded-r-lg font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 transition">
                📋 나의 예매 확인
            </button>
        </div>
    </footer>
    
    <!-- 6. MY BOOKING VIEW -->
    <section id="my-booking-view" class="view fixed inset-0 z-40 bg-white p-10 overflow-y-auto is-hidden">
        <button onclick="changeView('event-list-view', true)" class="text-blue-500 hover:text-blue-700 mb-6 flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            메인으로 돌아가기
        </button>
        <h2 class="header-font text-3xl font-bold mb-6 text-gray-800">나의 예매 확인 및 취소</h2>
        
        <form id="lookup-booking-form" class="space-y-4 p-6 border rounded-lg shadow-sm max-w-lg mx-auto bg-gray-50">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">예매 정보 조회</h3>
            <div>
                <label for="lookup-studentId" class="block text-sm font-medium text-gray-700">학번</label>
                <input type="text" id="lookup-studentId" autocomplete="off" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="lookup-bookingNumber" class="block text-sm font-medium text-gray-700">예매번호</label>
                <input type="text" id="lookup-bookingNumber" autocomplete="off" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button type="submit" class="w-full py-2 px-4 rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 transition">
                예매 내역 조회
            </button>
            <p id="lookup-error-message" class="text-red-500 text-sm is-hidden"></p>
        </form>

        <div id="booking-lookup-result" class="mt-8 max-w-lg mx-auto space-y-4 is-hidden">
            <h3 class="text-2xl font-bold text-gray-700 border-b pb-2">조회된 예매 내역</h3>
            <div id="result-card" class="p-6 border rounded-lg shadow-md bg-white">
                <!-- Booking details injected here -->
            </div>
            <button id="cancel-booking-btn" class="w-full py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
                예매 취소하기
            </button>
        </div>
    </section>

    <!-- Global Modal (for Queue and Confirmation Dialogs) -->
    <div id="global-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center is-hidden">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full transition-all duration-300 transform scale-95">
            <!-- Modal content injected here -->
        </div>
    </div>


    <script>
        // --- 1. GLOBAL SETUP AND UTILITIES ---
        
        // Provided Firebase Config & Initializing App
        const userFirebaseConfig = {
            apiKey: "AIzaSyCfgFrqqwTDssY11-Z1Ti1pNMSSWJIHA_Q",
            authDomain: "report209-16824.firebaseapp.com",
            projectId: "report209-16824",
            storageBucket: "report209-16824.firebasestorage.app",
            messagingSenderId: "45258886547",
            appId: "1:45258886547:web:3589999076939b8f58ec66",
            measurementId: "G-RRBM6LHGSY"
        };
        
        let app, auth, db, userId;
        let eventListenerUnsubs = [];
        let queueListenerUnsub = null;
        let currentEvent = null;
        let currentBookingData = null; // Used for lookup/cancellation

        // Global State
        const STATE = {
            currentView: 'event-list-view',
            // Max concurrent users in booking view
            QUEUE_LIMIT: 30, 
            SESSION_ID: crypto.randomUUID(),
            USER_INFO: null, // { name, studentId, phone }
            USER_IS_ADMIN: false,
            APP_ID: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'
        };

        const COLLECTIONS = {
            events: `artifacts/${STATE.APP_ID}/public/data/events`,
            bookings: `artifacts/${STATE.APP_ID}/public/data/bookings`,
            queue: `artifacts/${STATE.APP_ID}/public/data/queue_status`
        };

        // --- Firebase Initializer ---
        async function initializeFirebase() {
            try {
                if (!window.firebase) {
                    throw new Error("Firebase SDK not loaded. Check the script tags.");
                }
                
                app = firebase.initializeApp(userFirebaseConfig);
                auth = firebase.getAuth(app);
                db = firebase.getFirestore(app);

                // Disable Firestore logs (Optional, but can be verbose)
                firebase.setLogLevel('error');
                
                showLoading(true);

                // Authentication flow using custom token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await firebase.signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await firebase.signInAnonymously(auth);
                }

                // Wait for auth state to settle
                return new Promise(resolve => {
                    const unsubscribe = firebase.onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                            document.getElementById('user-id-display').classList.remove('hidden');
                            
                            // Check for admin status (simple client-side check for UI toggle)
                            const urlParams = new URLSearchParams(window.location.search);
                            if (urlParams.get('admin') === 'rrqq23' || STATE.USER_IS_ADMIN) {
                                STATE.USER_IS_ADMIN = true;
                                document.getElementById('user-id-display').textContent += ' | ADMIN MODE';
                            }
                            
                            resolve();
                        } else {
                            // Should not happen with anonymous sign-in, but handle if necessary
                            userId = null;
                            resolve();
                        }
                        unsubscribe();
                        showLoading(false);
                        loadEventList();
                    });
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`Firebase 초기화 실패: ${error.message}`, 'error');
                showLoading(false);
            }
        }
        
        // --- UI UTILITIES ---

        function showLoading(show) {
            document.getElementById('loading-spinner').classList.toggle('is-hidden', !show);
        }

        function showMessage(message, type = 'info', duration = 5000) {
            const msgEl = document.getElementById('global-message');
            msgEl.textContent = message;
            msgEl.className = 'w-full max-w-5xl p-3 mb-4 rounded-lg'; // Reset classes
            
            if (type === 'error') {
                msgEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
            } else if (type === 'success') {
                msgEl.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
            } else {
                msgEl.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
            }

            msgEl.classList.remove('is-hidden');
            
            clearTimeout(msgEl.timer);
            msgEl.timer = setTimeout(() => msgEl.classList.add('is-hidden'), duration);
        }

        /**
         * Converts UTC Date to KST formatted string.
         * @param {Date | firebase.firestore.Timestamp} date The date object or timestamp.
         * @returns {string} KST formatted string (YYYY.MM.DD HH:MM).
         */
        function formatKST(date) {
            const d = date.toDate ? date.toDate() : date;
            const options = {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false,
                timeZone: 'Asia/Seoul'
            };
            // Manually format to ensure YYYY.MM.DD HH:MM structure
            const parts = new Intl.DateTimeFormat('ko-KR', options).formatToParts(d);
            const year = parts.find(p => p.type === 'year').value;
            const month = parts.find(p => p.type === 'month').value;
            const day = parts.find(p => p.type === 'day').value;
            const hour = parts.find(p => p.type === 'hour').value;
            const minute = parts.find(p => p.type === 'minute').value;
            
            return `${year}.${month}.${day} ${hour}:${minute}`;
        }
        
        /**
         * Gets the current time in KST.
         * @returns {Date} Current KST Date object.
         */
        function getNowKST() {
            // This is the robust way to get a Date object representing the current KST time
            return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
        }

        // --- 2. VIEW MANAGEMENT ---

        function changeView(viewId, clearState = false) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('is-hidden');
            });
            document.getElementById(viewId).classList.remove('is-hidden');
            STATE.currentView = viewId;

            // Cleanup listeners when navigating away from booking view
            if (viewId !== 'booking-view') {
                unsubscribeAllListeners();
                // Ensure checkout happens if leaving the booking screen
                if (STATE.USER_INFO) {
                    checkOutQueue(STATE.USER_INFO.sessionId);
                }
                STATE.USER_INFO = null;
            }

            if (viewId === 'event-list-view' || viewId === 'my-booking-view') {
                 // Clear admin view if not an admin
                if (!STATE.USER_IS_ADMIN) {
                    document.getElementById('admin-view').classList.add('is-hidden');
                }
            }
            window.scrollTo(0, 0);
        }

        function unsubscribeAllListeners() {
            eventListenerUnsubs.forEach(unsub => unsub());
            eventListenerUnsubs = [];
            if (queueListenerUnsub) {
                queueListenerUnsub();
                queueListenerUnsub = null;
            }
        }

        // --- 3. CORE LOGIC: EVENT LIST & DETAILS ---

        function loadEventList() {
            const eventsRef = firebase.collection(db, COLLECTIONS.events);
            // Sort by start time for logical display
            const q = firebase.query(eventsRef, firebase.orderBy('startTime', 'asc'));

            unsubscribeAllListeners(); // Clear previous listeners
            const unsub = firebase.onSnapshot(q, (snapshot) => {
                const container = document.getElementById('events-container');
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    document.getElementById('no-events').classList.remove('is-hidden');
                    return;
                }
                document.getElementById('no-events').classList.add('is-hidden');

                snapshot.forEach(doc => {
                    const event = { id: doc.id, ...doc.data() };
                    const start = formatKST(event.startTime);
                    const end = formatKST(event.endTime);
                    
                    const now = getNowKST();
                    const isActive = now >= event.startTime.toDate() && now <= event.endTime.toDate();
                    const statusText = isActive ? 
                        `<span class="text-green-600 font-bold">예매 진행 중</span>` : 
                        (now < event.startTime.toDate() ? `<span class="text-blue-500">예매 예정 (${start})</span>` : `<span class="text-red-500">예매 종료</span>`);

                    const card = document.createElement('div');
                    card.className = "event-card p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-200 cursor-pointer bg-white";
                    card.innerHTML = `
                        <h3 class="header-font text-xl font-semibold text-gray-800">${event.title}</h3>
                        <p class="text-gray-600 my-1">${event.description}</p>
                        <p class="text-sm text-gray-500">기간: ${start} ~ ${end}</p>
                        <p class="text-sm mt-2">${statusText}</p>
                    `;
                    card.onclick = () => showEventDetails(event);
                    container.appendChild(card);
                });
            }, (error) => {
                console.error("Error loading events:", error);
                showMessage("이벤트 목록을 불러오는 데 실패했습니다.", 'error');
            });
            eventListenerUnsubs.push(unsub);
        }

        function showEventDetails(event) {
            currentEvent = event;
            document.getElementById('detail-event-title').textContent = event.title;
            document.getElementById('detail-event-desc').textContent = event.description;
            
            const now = getNowKST();
            const startTime = event.startTime.toDate();
            const endTime = event.endTime.toDate();
            const timeStatusEl = document.getElementById('time-status');
            const startBtn = document.getElementById('start-booking-btn');
            const userInfoForm = document.getElementById('user-info-form');

            if (now < startTime) {
                timeStatusEl.innerHTML = `아직 예매 시간이 아닙니다. 시작 시간: ${formatKST(startTime)} (KST)`;
                timeStatusEl.className = 'p-4 rounded-lg text-center font-semibold mb-6 bg-blue-100 text-blue-700';
                startBtn.disabled = true;
                userInfoForm.classList.add('opacity-50');
            } else if (now > endTime) {
                timeStatusEl.innerHTML = `예매가 종료되었습니다. 종료 시간: ${formatKST(endTime)} (KST)`;
                timeStatusEl.className = 'p-4 rounded-lg text-center font-semibold mb-6 bg-red-100 text-red-700';
                startBtn.disabled = true;
                userInfoForm.classList.add('opacity-50');
            } else {
                timeStatusEl.innerHTML = `현재 예매 진행 중입니다. 종료까지: ${formatKST(endTime)} (KST)`;
                timeStatusEl.className = 'p-4 rounded-lg text-center font-semibold mb-6 bg-green-100 text-green-700';
                startBtn.disabled = false;
                userInfoForm.classList.remove('opacity-50');
            }

            changeView('detail-auth-view');
        }

        // --- 4. AUTH & DUPLICATE CHECK ---

        document.getElementById('user-info-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const errorEl = document.getElementById('auth-error-message');
            errorEl.classList.add('is-hidden');
            
            showLoading(true);

            try {
                // 1. Duplicate Check
                const bookingsRef = firebase.collection(db, COLLECTIONS.bookings);
                const q = firebase.query(
                    bookingsRef,
                    firebase.where('event_id', '==', currentEvent.id),
                    firebase.where('studentId', '==', studentId),
                    firebase.limit(1)
                );
                const snapshot = await firebase.getDocs(q);

                if (!snapshot.empty) {
                    throw new Error("이미 동일한 학번으로 예매 기록이 존재합니다.");
                }

                // 2. Set User Info and Proceed
                STATE.USER_INFO = { name, studentId, phone, eventId: currentEvent.id, sessionId: STATE.SESSION_ID };
                await checkInQueue(); // Queue check is next
                
            } catch (error) {
                console.error("Auth/Duplicate Error:", error);
                errorEl.textContent = error.message;
                errorEl.classList.remove('is-hidden');
                showLoading(false);
            }
        });

        // --- 5. QUEUE MANAGEMENT ---
        
        async function checkInQueue() {
            const queueRef = firebase.doc(db, COLLECTIONS.queue, 'status');
            const userSessionId = STATE.SESSION_ID;
            
            try {
                await firebase.runTransaction(db, async (transaction) => {
                    const queueDoc = await transaction.get(queueRef);
                    const data = queueDoc.exists ? queueDoc.data() : { active_users: {}, waiting_users: {} };
                    const now = firebase.serverTimestamp();
                    
                    // Clean up stale users (optional, but good practice)
                    // (Omitted for brevity in this single file, assume simple check)

                    if (Object.keys(data.active_users).length < STATE.QUEUE_LIMIT) {
                        // Success: Move to active
                        data.active_users[userSessionId] = now;
                        transaction.set(queueRef, data);
                        return { status: 'ACTIVE' };
                    } else {
                        // Waitlist: Add to waiting
                        data.waiting_users[userSessionId] = now;
                        transaction.set(queueRef, data);
                        return { status: 'WAITING' };
                    }
                }).then(result => {
                    showLoading(false);
                    if (result.status === 'ACTIVE') {
                        setupBookingView();
                    } else {
                        showQueueModal();
                    }
                });
            } catch (error) {
                showLoading(false);
                showMessage(`대기열 진입 중 오류 발생: ${error.message}`, 'error');
            }
        }

        async function checkOutQueue(sessionId) {
            if (!sessionId) return;
            const queueRef = firebase.doc(db, COLLECTIONS.queue, 'status');
            
            try {
                await firebase.runTransaction(db, async (transaction) => {
                    const queueDoc = await transaction.get(queueRef);
                    if (!queueDoc.exists) return;
                    
                    const data = queueDoc.data();
                    let promoted = false;

                    // 1. Remove user from active list
                    if (data.active_users[sessionId]) {
                        delete data.active_users[sessionId];
                        
                        // 2. Promote next user if slot is free and someone is waiting
                        if (Object.keys(data.waiting_users).length > 0 && Object.keys(data.active_users).length < STATE.QUEUE_LIMIT) {
                            
                            // Find the oldest timestamp in waiting_users
                            const waitingList = Object.entries(data.waiting_users).map(([id, time]) => ({ id, time: time.toMillis() }));
                            waitingList.sort((a, b) => a.time - b.time); // Sort by oldest first
                            
                            const nextUser = waitingList[0];
                            if (nextUser) {
                                // Promote
                                delete data.waiting_users[nextUser.id];
                                data.active_users[nextUser.id] = firebase.serverTimestamp();
                                promoted = true;
                            }
                        }
                        transaction.set(queueRef, data);
                    }
                    // No need to remove from waiting if they didn't reach active
                });
            } catch (error) {
                console.error("Queue Checkout Error (Non-critical):", error);
            }
        }
        
        function showQueueModal() {
            const modal = document.getElementById('global-modal');
            const content = document.getElementById('modal-content');
            
            const renderQueueModal = (data) => {
                const waitingUsers = data.waiting_users || {};
                const activeUsers = data.active_users || {};
                
                const waitingList = Object.entries(waitingUsers).map(([id, time]) => ({ id, time: time.toMillis() }));
                waitingList.sort((a, b) => a.time - b.time); // Sort by oldest first
                
                const myIndex = waitingList.findIndex(user => user.id === STATE.SESSION_ID);
                const myPriority = myIndex !== -1 ? myIndex + 1 : 0;
                const behindMe = myIndex !== -1 ? waitingList.length - 1 - myIndex : waitingList.length;

                if (activeUsers[STATE.SESSION_ID]) {
                    // User was promoted, close modal and proceed
                    modal.classList.add('is-hidden');
                    unsubscribeAllListeners();
                    setupBookingView();
                    return;
                }

                content.innerHTML = `
                    <h3 class="header-font text-2xl font-bold mb-4 text-center text-blue-600">접속 대기열</h3>
                    <p class="text-gray-700 text-center mb-4">현재 접속량이 많아 순서대로 예매 창으로 이동 중입니다.</p>
                    <div class="p-4 border rounded-lg bg-gray-50 space-y-2">
                        <p class="font-semibold text-lg">나의 현재 우선순위: <span class="text-blue-600">${myPriority}</span></p>
                        <p class="text-sm">나의 뒤로 대기 인원: ${behindMe}명</p>
                        <p class="text-sm">현재 예매 중인 인원: ${Object.keys(activeUsers).length}명 / ${STATE.QUEUE_LIMIT}명</p>
                    </div>
                    <div class="mt-4 w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full animate-pulse" style="width: 100%"></div>
                    </div>
                `;
            };

            // Set up listener for queue status
            const queueRef = firebase.doc(db, COLLECTIONS.queue, 'status');
            queueListenerUnsub = firebase.onSnapshot(queueRef, (doc) => {
                if (doc.exists) {
                    renderQueueModal(doc.data());
                } else {
                    // If queue doc doesn't exist, assume no one is active and let user in (or retry checkInQueue)
                    checkInQueue();
                }
            }, (error) => {
                console.error("Queue Listener Error:", error);
                showMessage("대기열 상태 확인 중 오류가 발생했습니다.", 'error');
                modal.classList.add('is-hidden');
            });
            
            modal.classList.remove('is-hidden');
        }

        // --- 6. BOOKING VIEWS (Seats/Choices) ---

        function setupBookingView() {
            document.getElementById('booking-title').textContent = `${currentEvent.title} 예매`;
            document.getElementById('booking-content-container').innerHTML = ''; // Clear old content
            document.getElementById('queue-info-banner').classList.remove('is-hidden');
            document.getElementById('active-user-count').textContent = STATE.QUEUE_LIMIT; // Display limit in banner

            // Start queue info banner listener
            const queueRef = firebase.doc(db, COLLECTIONS.queue, 'status');
            const unsubQueue = firebase.onSnapshot(queueRef, (doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('active-user-count').textContent = Object.keys(data.active_users || {}).length;
                }
            });
            eventListenerUnsubs.push(unsubQueue);

            if (currentEvent.type === 'seats') {
                renderSeatsView();
            } else if (currentEvent.type === 'choices') {
                renderChoicesView();
            } else {
                document.getElementById('booking-content-container').innerHTML = '<p class="text-red-500">잘못된 예매 타입입니다.</p>';
            }

            changeView('booking-view');
        }

        // --- CHOICES VIEW ---
        function renderChoicesView() {
            const container = document.getElementById('booking-content-container');
            container.innerHTML = `<div id="choices-list" class="space-y-4"></div>`;
            const choicesRef = firebase.collection(db, COLLECTIONS.events, currentEvent.id, 'choices');
            
            const unsub = firebase.onSnapshot(choicesRef, (snapshot) => {
                const listEl = document.getElementById('choices-list');
                listEl.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const choice = { id: doc.id, ...doc.data() };
                    const remaining = choice.limit - (choice.count || 0);
                    const isAvailable = remaining > 0;
                    
                    const card = document.createElement('div');
                    card.className = `p-4 border rounded-lg flex justify-between items-center ${isAvailable ? 'bg-white shadow-md' : 'bg-gray-100 text-gray-500'}`;
                    
                    card.innerHTML = `
                        <div>
                            <p class="text-lg font-semibold">${choice.name}</p>
                            <p class="text-sm">${remaining} / ${choice.limit} 자리 남음</p>
                        </div>
                        <button data-choice-id="${choice.id}" ${isAvailable ? '' : 'disabled'}
                            class="choice-btn py-2 px-4 rounded-md text-white font-medium transition ${isAvailable ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'}"
                        >
                            ${isAvailable ? '예매하기' : '마감'}
                        </button>
                    `;
                    listEl.appendChild(card);
                });
                
                listEl.querySelectorAll('.choice-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleChoiceBooking(btn.getAttribute('data-choice-id')));
                });
            });
            eventListenerUnsubs.push(unsub);
        }

        async function handleChoiceBooking(choiceId) {
            showLoading(true);
            const choiceRef = firebase.doc(db, COLLECTIONS.events, currentEvent.id, 'choices', choiceId);
            
            try {
                const bookingNumber = crypto.randomUUID().substring(0, 8).toUpperCase();
                
                await firebase.runTransaction(db, async (transaction) => {
                    const choiceDoc = await transaction.get(choiceRef);
                    if (!choiceDoc.exists) throw new Error("선택지를 찾을 수 없습니다.");
                    
                    const data = choiceDoc.data();
                    const currentCount = data.count || 0;
                    
                    if (currentCount >= data.limit) {
                        throw new Error("이미 마감된 선택지입니다. 다시 시도해 주세요.");
                    }

                    // 1. Update Choice Count
                    const newCount = currentCount + 1;
                    transaction.update(choiceRef, { 
                        count: newCount 
                    });
                    
                    // 2. Add Booking Record
                    const bookingRef = firebase.doc(firebase.collection(db, COLLECTIONS.bookings)); // Auto-generate ID
                    transaction.set(bookingRef, {
                        event_id: currentEvent.id,
                        studentId: STATE.USER_INFO.studentId,
                        name: STATE.USER_INFO.name,
                        phone: STATE.USER_INFO.phone,
                        type: 'choice',
                        selection: data.name,
                        bookingNumber: bookingNumber,
                        timestamp: firebase.serverTimestamp(),
                        userId: userId,
                    });
                    
                });

                // Success
                await checkOutQueue(STATE.SESSION_ID);
                showConfirmation(STATE.USER_INFO.name, STATE.USER_INFO.studentId, choiceDoc.data().name, bookingNumber);
                
            } catch (error) {
                console.error("Choice Booking Error:", error);
                showMessage(`예매 실패: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }


        // --- SEATS VIEW ---
        function renderSeatsView() {
            const container = document.getElementById('booking-content-container');
            container.innerHTML = `<div id="seats-grid" class="flex flex-col items-center p-4 bg-gray-100 rounded-lg shadow-inner"></div>`;
            const seatsRef = firebase.collection(db, COLLECTIONS.events, currentEvent.id, 'seats');
            
            const unsub = firebase.onSnapshot(seatsRef, (snapshot) => {
                const seats = [];
                snapshot.forEach(doc => {
                    seats.push({ id: doc.id, ...doc.data() });
                });
                
                drawSeatsGrid(seats);
            });
            eventListenerUnsubs.push(unsub);
        }

        function drawSeatsGrid(seats) {
            const gridEl = document.getElementById('seats-grid');
            gridEl.innerHTML = '';
            
            // Group seats by row
            const rows = seats.reduce((acc, seat) => {
                acc[seat.row] = acc[seat.row] || [];
                acc[seat.row].push(seat);
                return acc;
            }, {});

            const sortedRows = Object.keys(rows).sort(); // Sort rows alphabetically/numerically
            
            sortedRows.forEach(rowKey => {
                const rowEl = document.createElement('div');
                rowEl.className = 'flex space-x-2 my-1';
                rowEl.innerHTML = `<div class="w-8 h-8 flex items-center justify-center text-sm font-bold text-gray-700">${rowKey}</div>`; // Row label
                
                // Sort columns numerically
                rows[rowKey].sort((a, b) => a.col - b.col).forEach(seat => {
                    const seatEl = document.createElement('div');
                    const seatId = `${seat.row}${seat.col}`;
                    seatEl.id = `seat-${seat.id}`;
                    seatEl.className = `seat w-8 h-8 rounded-lg flex items-center justify-center text-sm font-medium transition duration-100 ease-in-out select-none`;
                    seatEl.textContent = seat.col;

                    if (seat.isBooked) {
                        seatEl.classList.add('reserved');
                    } else {
                        seatEl.classList.add('available');
                        seatEl.onclick = () => handleSeatBooking(seat.id, seatId);
                    }
                    rowEl.appendChild(seatEl);
                });
                gridEl.appendChild(rowEl);
            });
            gridEl.innerHTML = '<div class="text-center w-full my-4 py-2 bg-gray-200 rounded-md font-semibold text-gray-700">스크린</div>' + gridEl.innerHTML;
        }

        async function handleSeatBooking(seatDocId, seatId) {
            showLoading(true);
            const seatRef = firebase.doc(db, COLLECTIONS.events, currentEvent.id, 'seats', seatDocId);

            try {
                const bookingNumber = crypto.randomUUID().substring(0, 8).toUpperCase();
                
                await firebase.runTransaction(db, async (transaction) => {
                    const seatDoc = await transaction.get(seatRef);
                    if (!seatDoc.exists) throw new Error("좌석을 찾을 수 없습니다.");
                    
                    if (seatDoc.data().isBooked) {
                        throw new Error("이미 예약된 좌석입니다. 다른 좌석을 선택해주세요.");
                    }
                    
                    // 1. Add Booking Record
                    const bookingRef = firebase.doc(firebase.collection(db, COLLECTIONS.bookings)); // Auto-generate ID
                    transaction.set(bookingRef, {
                        event_id: currentEvent.id,
                        studentId: STATE.USER_INFO.studentId,
                        name: STATE.USER_INFO.name,
                        phone: STATE.USER_INFO.phone,
                        type: 'seat',
                        selection: seatId,
                        bookingNumber: bookingNumber,
                        timestamp: firebase.serverTimestamp(),
                        userId: userId,
                    });
                    
                    // 2. Update Seat Status
                    transaction.update(seatRef, {
                        isBooked: true,
                        bookingId: bookingRef.id,
                    });
                    
                });

                // Success
                await checkOutQueue(STATE.SESSION_ID);
                showConfirmation(STATE.USER_INFO.name, STATE.USER_INFO.studentId, seatId, bookingNumber);

            } catch (error) {
                console.error("Seat Booking Error:", error);
                showMessage(`예매 실패: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // --- 7. CONFIRMATION VIEW ---
        
        function showConfirmation(name, studentId, selection, bookingNumber) {
            document.getElementById('conf-name').textContent = name;
            document.getElementById('conf-studentId').textContent = studentId;
            document.getElementById('conf-selection').textContent = selection;
            document.getElementById('conf-bookingNumber').textContent = bookingNumber;
            
            // Clear current event state
            currentEvent = null;
            
            changeView('confirmation-view');
        }

        // --- 8. MY BOOKING LOOKUP & CANCEL ---

        document.getElementById('lookup-booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('lookup-studentId').value.trim();
            const bookingNumber = document.getElementById('lookup-bookingNumber').value.trim();
            const errorEl = document.getElementById('lookup-error-message');
            const resultEl = document.getElementById('booking-lookup-result');
            const resultCard = document.getElementById('result-card');
            
            errorEl.classList.add('is-hidden');
            resultEl.classList.add('is-hidden');
            showLoading(true);
            currentBookingData = null;

            try {
                const bookingsRef = firebase.collection(db, COLLECTIONS.bookings);
                const q = firebase.query(
                    bookingsRef,
                    firebase.where('studentId', '==', studentId),
                    firebase.where('bookingNumber', '==', bookingNumber),
                    firebase.limit(1)
                );
                const snapshot = await firebase.getDocs(q);

                if (snapshot.empty) {
                    throw new Error("일치하는 예매 내역을 찾을 수 없습니다.");
                }

                const doc = snapshot.docs[0];
                const booking = { id: doc.id, ...doc.data() };
                currentBookingData = booking;

                // Fetch event details
                const eventDoc = await firebase.getDoc(firebase.doc(db, COLLECTIONS.events, booking.event_id));
                const eventTitle = eventDoc.exists ? eventDoc.data().title : '알 수 없는 이벤트';

                resultCard.innerHTML = `
                    <p class="text-lg font-bold">${eventTitle}</p>
                    <p class="mt-2"><span class="font-semibold">예매 번호:</span> ${booking.bookingNumber}</p>
                    <p><span class="font-semibold">이름:</span> ${booking.name}</p>
                    <p><span class="font-semibold">선택:</span> <span class="text-blue-600 font-bold">${booking.selection}</span></p>
                    <p><span class="font-semibold">예매 일시:</span> ${formatKST(booking.timestamp)}</p>
                `;
                resultEl.classList.remove('is-hidden');

            } catch (error) {
                console.error("Lookup Error:", error);
                errorEl.textContent = error.message;
                errorEl.classList.remove('is-hidden');
            } finally {
                showLoading(false);
            }
        });

        document.getElementById('cancel-booking-btn').addEventListener('click', async () => {
            if (!currentBookingData) return;
            
            const confirmed = window.confirm(`정말로 예매번호 ${currentBookingData.bookingNumber} 예매를 취소하시겠습니까?`);
            if (!confirmed) return;
            
            showLoading(true);
            const bookingRef = firebase.doc(db, COLLECTIONS.bookings, currentBookingData.id);
            
            try {
                await firebase.runTransaction(db, async (transaction) => {
                    const bookingDoc = await transaction.get(bookingRef);
                    if (!bookingDoc.exists) throw new Error("취소할 예매 내역이 이미 삭제되었거나 존재하지 않습니다.");
                    
                    const booking = bookingDoc.data();
                    
                    // 1. Data Restoration (Releasing the spot)
                    if (booking.type === 'choices') {
                        // Restore count for choices
                        const choiceRef = firebase.doc(db, COLLECTIONS.events, booking.event_id, 'choices', booking.selection);
                        // NOTE: For 'choices', the selection field stores the *choice document ID* in this design for easy lookup.
                        transaction.update(choiceRef, { 
                            count: firebase.FieldValue.increment(-1)
                        });
                        
                    } else if (booking.type === 'seat') {
                        // Release seat
                        const seatRef = firebase.doc(db, COLLECTIONS.events, booking.event_id, 'seats', booking.bookingId);
                        transaction.update(seatRef, { 
                            isBooked: false,
                            bookingId: null,
                        });
                    }
                    
                    // 2. Delete Booking Record
                    transaction.delete(bookingRef);
                });
                
                showMessage(`예매번호 ${currentBookingData.bookingNumber}가 성공적으로 취소되었습니다.`, 'success');
                document.getElementById('booking-lookup-result').classList.add('is-hidden');
                document.getElementById('lookup-booking-form').reset();
                currentBookingData = null;

            } catch (error) {
                console.error("Cancellation Error:", error);
                showMessage(`취소 실패: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        });

        // --- 9. ADMIN MODE (rrqq23) ---

        let adminKeySequence = '';
        const ADMIN_CODE = 'rrqq23';
        
        document.addEventListener('keydown', (e) => {
            if (STATE.USER_IS_ADMIN) return;

            // Only listen on main view
            if (STATE.currentView === 'event-list-view') {
                const key = e.key.toLowerCase();
                adminKeySequence += key;
                if (adminKeySequence.length > ADMIN_CODE.length) {
                    adminKeySequence = adminKeySequence.substring(1);
                }
                
                if (adminKeySequence === ADMIN_CODE) {
                    STATE.USER_IS_ADMIN = true;
                    showMessage("관리자 모드로 전환되었습니다.", 'success');
                    changeView('admin-view');
                    setupAdminView();
                }
            }
        });
        
        function setupAdminView() {
            if (!STATE.USER_IS_ADMIN) return;
            // Admin only actions for now: Event creation and listing

            // Type-specific config listener
            document.getElementById('admin-type').addEventListener('change', (e) => {
                const configEl = document.getElementById('admin-type-specific-config');
                configEl.classList.remove('is-hidden');
                configEl.innerHTML = '';

                if (e.target.value === 'choices') {
                    configEl.innerHTML = `
                        <h4 class="font-semibold">선택지 설정 (옵션명, 리밋)</h4>
                        <textarea id="admin-choices-data" placeholder="예: 1회차, 100&#10;2회차, 50" class="w-full p-2 border rounded" required></textarea>
                        <p class="text-xs text-gray-500">줄바꿈으로 구분, 쉼표(,)로 옵션명과 최대 리밋(숫자) 구분</p>
                    `;
                } else if (e.target.value === 'seats') {
                    configEl.innerHTML = `
                        <h4 class="font-semibold">좌석 설정 (행, 열)</h4>
                        <input type="text" id="admin-seat-rows" placeholder="행 이름 (예: A,B,C)" required class="w-full p-2 border rounded mb-2">
                        <input type="number" id="admin-seat-cols" placeholder="최대 열 수 (예: 10)" required class="w-full p-2 border rounded">
                        <p class="text-xs text-gray-500">행은 쉼표로 구분 (A,B,C), 열은 숫자 입력</p>
                    `;
                } else {
                    configEl.classList.add('is-hidden');
                }
            });

            // Initial load for management list
            loadAdminEventList();
        }

        async function loadAdminEventList() {
             const eventsRef = firebase.collection(db, COLLECTIONS.events);
            const q = firebase.query(eventsRef, firebase.orderBy('startTime', 'asc'));

            const unsub = firebase.onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('admin-event-list');
                listEl.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const event = { id: doc.id, ...doc.data() };
                    const start = formatKST(event.startTime);
                    const end = formatKST(event.endTime);
                    
                    const card = document.createElement('div');
                    card.className = "p-4 border rounded-lg shadow-sm bg-white";
                    card.innerHTML = `
                        <p class="header-font text-xl font-bold">${event.title} <span class="text-sm text-gray-500">(${event.type})</span></p>
                        <p class="text-sm text-gray-600">기간: ${start} ~ ${end}</p>
                        <button onclick="viewAdminBookings('${event.id}', '${event.title}', '${event.type}')" class="mt-2 text-sm py-1 px-3 bg-blue-100 text-blue-800 rounded hover:bg-blue-200 transition">
                            예매 내역 확인
                        </button>
                    `;
                    listEl.appendChild(card);
                });
            });
            eventListenerUnsubs.push(unsub);
        }

        document.getElementById('create-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);

            const title = document.getElementById('admin-title').value.trim();
            const description = document.getElementById('admin-description').value.trim();
            const type = document.getElementById('admin-type').value;
            // datetime-local gives YYYY-MM-DDTHH:MM (local time string), convert to UTC Date
            const startTimeKST = document.getElementById('admin-start-time').value;
            const endTimeKST = document.getElementById('admin-end-time').value;
            
            // NOTE: Must convert KST string back to UTC timestamp for Firebase
            const convertToUTC = (kstString) => new Date(new Date(kstString).toLocaleString('en-US', { timeZone: 'UTC' }));
            
            try {
                // 1. Create main event document
                const eventsRef = firebase.collection(db, COLLECTIONS.events);
                const newEventRef = firebase.doc(eventsRef); // Get a new doc reference
                
                await firebase.setDoc(newEventRef, {
                    title,
                    description,
                    type,
                    startTime: convertToUTC(startTimeKST),
                    endTime: convertToUTC(endTimeKST)
                });

                // 2. Create sub-collection data based on type
                if (type === 'choices') {
                    const choicesData = document.getElementById('admin-choices-data').value.trim().split('\n');
                    const choicesRef = firebase.collection(db, COLLECTIONS.events, newEventRef.id, 'choices');
                    
                    for (const line of choicesData) {
                        const [name, limitStr] = line.split(',').map(s => s.trim());
                        if (name && limitStr) {
                            await firebase.addDoc(choicesRef, { name, limit: parseInt(limitStr), count: 0 });
                        }
                    }
                } else if (type === 'seats') {
                    const rowsInput = document.getElementById('admin-seat-rows').value.trim();
                    const colsInput = parseInt(document.getElementById('admin-seat-cols').value, 10);
                    const rows = rowsInput.split(',').map(r => r.trim());
                    const seatsRef = firebase.collection(db, COLLECTIONS.events, newEventRef.id, 'seats');
                    
                    for (const row of rows) {
                        for (let col = 1; col <= colsInput; col++) {
                            await firebase.addDoc(seatsRef, {
                                row,
                                col,
                                isBooked: false,
                                bookingId: null,
                            });
                        }
                    }
                }

                showMessage(`이벤트 '${title}'가 성공적으로 생성되었습니다.`, 'success');
                document.getElementById('create-event-form').reset();
            } catch (error) {
                console.error("Event Creation Error:", error);
                showMessage(`이벤트 생성 실패: ${error.message}`, 'error', 10000);
            } finally {
                showLoading(false);
            }
        });

        // Simplified Admin Booking View (using Modal for detail)
        function viewAdminBookings(eventId, eventTitle, eventType) {
            const modal = document.getElementById('global-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('is-hidden');

            content.innerHTML = `
                <h3 class="header-font text-2xl font-bold mb-4 text-center">${eventTitle} 예매 내역</h3>
                <div id="admin-booking-list" class="max-h-96 overflow-y-auto space-y-2">
                    <p class="text-center text-gray-500">로딩 중...</p>
                </div>
                <button onclick="document.getElementById('global-modal').classList.add('is-hidden')" class="mt-4 w-full py-2 bg-gray-200 rounded hover:bg-gray-300">닫기</button>
            `;

            const listEl = document.getElementById('admin-booking-list');
            const bookingsRef = firebase.collection(db, COLLECTIONS.bookings);
            const q = firebase.query(
                bookingsRef,
                firebase.where('event_id', '==', eventId),
                firebase.orderBy('timestamp', 'desc')
            );

            // Fetch once (not real-time for admin detail view to avoid excessive use)
            firebase.getDocs(q).then(snapshot => {
                if (snapshot.empty) {
                    listEl.innerHTML = `<p class="text-center text-gray-500 p-4">예매 내역이 없습니다.</p>`;
                    return;
                }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const booking = { id: doc.id, ...doc.data() };
                    const item = document.createElement('div');
                    item.className = 'p-3 border rounded flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold">${booking.name} (${booking.studentId})</p>
                            <p class="text-sm text-blue-600">${booking.selection}</p>
                            <p class="text-xs text-gray-500">${booking.bookingNumber}</p>
                        </div>
                        <button onclick="adminDeleteBooking('${booking.id}', '${booking.event_id}', '${booking.type}', '${booking.selection}', '${booking.bookingId || booking.selection}')" 
                            class="text-sm py-1 px-2 bg-red-500 text-white rounded hover:bg-red-600">
                            삭제
                        </button>
                    `;
                    listEl.appendChild(item);
                });
            }).catch(error => {
                listEl.innerHTML = `<p class="text-red-500">내역 로딩 오류: ${error.message}</p>`;
                console.error("Admin Booking Load Error:", error);
            });
        }
        
        async function adminDeleteBooking(bookingId, eventId, type, selection, bookingRefId) {
            const confirmed = window.confirm(`정말로 예매번호 ${bookingId}의 내역을 삭제하시겠습니까? (복구 불가)`);
            if (!confirmed) return;
            
            showLoading(true);
            const bookingRef = firebase.doc(db, COLLECTIONS.bookings, bookingId);
            
            try {
                await firebase.runTransaction(db, async (transaction) => {
                    // 1. Delete Booking Record
                    transaction.delete(bookingRef);
                    
                    // 2. Data Restoration (Releasing the spot)
                    if (type === 'choices') {
                        // Restore count for choices (selection stores the name, need to get the actual doc ID)
                        // This requires an extra query which is bad in a transaction, let's assume 'selection' stored the choiceId initially for simplicity.
                        // Based on the choice booking handler, the selection is the choice *name* but the choiceRef is constructed with the ID. 
                        // To fix, we use the bookingRefId passed which is the choice ID.
                        const choiceRef = firebase.doc(db, COLLECTIONS.events, eventId, 'choices', bookingRefId);
                        transaction.update(choiceRef, { 
                            count: firebase.FieldValue.increment(-1)
                        });
                        
                    } else if (type === 'seat') {
                        // Release seat (bookingRefId is the seat doc ID)
                        const seatRef = firebase.doc(db, COLLECTIONS.events, eventId, 'seats', bookingRefId);
                        transaction.update(seatRef, { 
                            isBooked: false,
                            bookingId: null,
                        });
                    }
                });
                
                showMessage(`예매 내역(ID: ${bookingId})이 성공적으로 삭제되었습니다.`, 'success');
                // Refresh modal content
                document.getElementById('global-modal').classList.add('is-hidden');
                
            } catch (error) {
                console.error("Admin Delete Error:", error);
                showMessage(`삭제 실패: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }


        // --- 10. INITIALIZATION ---

        window.onload = initializeFirebase;
        
    </script>
</body>
</html>
