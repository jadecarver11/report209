<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KST ì´ë²¤íŠ¸ ì˜ˆë§¤ ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Paperlogy Web Font -->
    <link href="https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/Paperlogy.css" rel="stylesheet">
    <style>
        /* Custom Styles for Aesthetics */
        body {
            font-family: 'Paperlogy', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .kst-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .kst-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background-color: #10b981; /* Emerald Green */
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #059669;
        }
        .btn-primary:disabled {
            background-color: #a7f3d0;
            cursor: not-allowed;
        }
        .kst-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }
        .seat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
        }
        .seat {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }
        .seat:hover:not(.bg-red-500):not(.bg-blue-500) {
            transform: scale(1.05);
        }
        .is-hidden {
            display: none !important;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, runTransaction, FieldValue, serverTimestamp, getDocs, limit, orderBy, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope for use in the script tag
        window.firebase = {
            initializeApp, setLogLevel, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, runTransaction, FieldValue, serverTimestamp, getDocs, limit, orderBy, writeBatch, Timestamp
        };

        // --- 1. Global Setup ---
        
        // Canvas í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (í•„ìˆ˜)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // setLogLevel('debug'); // ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™” (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
        const ADMIN_KEY = "rrqq23"; // ê´€ë¦¬ì í‚¤
        
        let db;
        let auth;
        let userId = null; // í˜„ì¬ ì‚¬ìš©ìì˜ UID
        let currentEventData = null; // í˜„ì¬ ì„ íƒëœ ì´ë²¤íŠ¸ ì •ë³´
        let bookingUserData = null; // ì˜ˆë§¤ì ì •ë³´ (ì´ë¦„, í•™ë²ˆ, ì „í™”ë²ˆí˜¸)
        let isBooking = false; // ì¤‘ë³µ ì˜ˆë§¤/í ì§„ì… ë°©ì§€ í”Œë˜ê·¸
        let queueListenerUnsubscribe = null; // í ë¦¬ìŠ¤ë„ˆ í•´ì œ í•¨ìˆ˜
        let editingEventId = null; // ìˆ˜ì • ì¤‘ì¸ ì´ë²¤íŠ¸ ID
        
        let COLLECTIONS = {
            events: 'artifacts/' + appId + '/public/data/events',
            bookings: null, // User specific, defined after auth
            queueStatus: 'artifacts/' + appId + '/public/data/queue_status', // Public queue data
            adminBookings: 'artifacts/' + appId + '/public/data/adminBookings' // Public record of all bookings
        };

        // --- 2. Utility Functions ---
        
        /**
         * Firestore Timestampë¥¼ KST ë¬¸ìì—´ë¡œ í¬ë§·í•©ë‹ˆë‹¤.
         */
        function formatKstTime(timestamp, includeSeconds = false) {
            if (!timestamp || !timestamp.toDate) return 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            const date = timestamp.toDate();
            return date.toLocaleString('ko-KR', { 
                timeZone: 'Asia/Seoul', 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: includeSeconds ? '2-digit' : undefined,
                hour12: false 
            }).replace(/\. /g, '/').replace('.', '').trim();
        }
        
        /** KST datetime-local ì…ë ¥ê°’ì„ Timestampë¡œ ë³€í™˜ */
        function getKstTimestamp(datetimeLocalValue) {
            if (!datetimeLocalValue) return null;
            // KST ì‹œê°„ëŒ€ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•˜ì—¬ Date ê°ì²´ ìƒì„± (2025-10-20T10:00:00)
            const date = new Date(datetimeLocalValue + ":00+09:00"); 
            return firebase.Timestamp.fromDate(date);
        }
        
        /** í˜„ì¬ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆë§¤ ìƒíƒœ í™•ì¸ */
        function getBookingStatus(startTime, endTime) {
            const now = firebase.Timestamp.now();
            if (now.seconds < startTime.seconds) {
                return { status: 'ì¤€ë¹„ ì¤‘', color: 'bg-yellow-500', isAvailable: false };
            }
            if (now.seconds >= startTime.seconds && now.seconds <= endTime.seconds) {
                return { status: 'ì˜ˆë§¤ ê°€ëŠ¥', color: 'bg-green-600', isAvailable: true };
            }
            return { status: 'ì˜ˆë§¤ ì¢…ë£Œ', color: 'bg-gray-500', isAvailable: false };
        }

        /** íŒì—…ì°½ ëŒ€ì‹  ìš°ì¸¡ ìƒë‹¨ì— ë¹„ë™ê¸° ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. */
        function showMessage(message, type = 'blue', duration = 3000) {
            const app = document.getElementById('app');
            let msgEl = document.getElementById('custom-alert-msg');
            
            if (!msgEl) {
                msgEl = document.createElement('div');
                msgEl.id = 'custom-alert-msg';
                msgEl.className = 'fixed top-4 right-4 z-[100] p-4 rounded-lg shadow-xl text-white font-semibold transition-all duration-300 transform translate-y-full opacity-0';
                document.body.appendChild(msgEl); 
            }
            
            msgEl.textContent = message;
            
            const colors = {
                blue: 'bg-blue-600',
                green: 'bg-green-600',
                red: 'bg-red-600',
                yellow: 'bg-yellow-600',
                warning: 'bg-orange-500',
                error: 'bg-red-600',
                success: 'bg-green-600'
            };
            msgEl.className = msgEl.className.split(' ').filter(c => !c.startsWith('bg-')).join(' ') + ' ' + (colors[type] || colors.blue);

            msgEl.classList.remove('opacity-0', 'translate-y-full');
            msgEl.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                msgEl.classList.remove('opacity-100', 'translate-y-0');
                msgEl.classList.add('opacity-0', 'translate-y-full');
            }, duration);
        }
        window.showMessage = showMessage;

        /** ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ/ìˆ¨ê¹€ */
        function showLoading(show, text = "ì²˜ë¦¬ ì¤‘...") {
            const el = document.getElementById('global-loading');
            if (!el) return;
            if (show) {
                el.querySelector('#loading-text').textContent = text;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }
        window.showLoading = showLoading;
        
        /** ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€ (ì˜ˆë§¤ ì™„ë£Œ/ê´€ë¦¬ì ì•Œë¦¼ ë“±) */
        function showGlobalModal(show, title, contentHTML, buttonsHTML = '', size = 'max-w-md') {
            const modalEl = document.getElementById('global-modal');
            if (!modalEl) return;
            const contentContainer = document.getElementById('global-modal-content');

            if (show) {
                contentContainer.className = `bg-white p-6 rounded-xl shadow-2xl w-full ${size} text-center`;
                modalEl.querySelector('#global-modal-title').textContent = title;
                modalEl.querySelector('#global-modal-body').innerHTML = contentHTML;
                modalEl.querySelector('#global-modal-buttons').innerHTML = buttonsHTML;
                modalEl.classList.remove('is-hidden');
            } else {
                modalEl.classList.add('is-hidden');
            }
        }
        window.showGlobalModal = showGlobalModal;


        // --- 3. UI Control and View State ---

        let views = {}; // DOM ë¡œë“œ í›„ ì´ˆê¸°í™”
        
        /** ë·° ì „í™˜ í•¨ìˆ˜ */
        function setView(activeView) {
            // Unsubscribe from any active listeners when changing views
            if (queueListenerUnsubscribe) {
                queueListenerUnsubscribe();
                queueListenerUnsubscribe = null;
            }
            
            const queueModal = document.getElementById('queue-modal');
            const globalModal = document.getElementById('global-modal');

            if (queueModal) queueModal.classList.add('is-hidden'); // í ëª¨ë‹¬ ë‹«ê¸°
            if (globalModal) globalModal.classList.add('is-hidden'); // ì¼ë°˜ ëª¨ë‹¬ ë‹«ê¸°

            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (activeView) {
                activeView.classList.remove('hidden');
                if (activeView === views.admin) {
                    loadAdminEvents(); // ê´€ë¦¬ì ë·°ë¡œ ì „í™˜ ì‹œ ì´ë²¤íŠ¸ ëª©ë¡ ë¡œë“œ
                }
            }
        }

        /** ì´ë²¤íŠ¸ ëª©ë¡ ë·°ë¡œ ì „í™˜ */
        function showEventList() {
            setView(views.list);
        }
        window.showEventList = showEventList;

        /** ì˜ˆë§¤ì ì •ë³´ ì €ì¥ */
        function setBookingUserData(data) {
            bookingUserData = data;
            const summaryNameEl = document.getElementById('summary-name');
            const summaryStudentIdEl = document.getElementById('summary-student-id');
            if (summaryNameEl) summaryNameEl.textContent = data.name;
            if (summaryStudentIdEl) summaryStudentIdEl.textContent = data.studentId;
            COLLECTIONS.bookings = 'artifacts/' + appId + '/users/' + userId + '/bookings';
        }

        /** ì˜ˆë§¤ ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¹€ */
        function hideBookingError() {
            const errorEl = document.getElementById('booking-error-msg');
            if (errorEl) {
                errorEl.classList.add('hidden');
                errorEl.textContent = '';
            }
        }

        /** ê´€ë¦¬ì ëª¨ë“œ ì „í™˜ */
        window.toggleAdminView = function() {
            const key = prompt("ê´€ë¦¬ì í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (key === ADMIN_KEY) {
                showMessage("ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.", 'success');
                setView(views.admin);
            } else if (key !== null) {
                showMessage("ì˜ëª»ëœ ê´€ë¦¬ì í‚¤ì…ë‹ˆë‹¤.", 'error');
            }
        };

        /** ê´€ë¦¬ì ëª¨ë“œ í•´ì œ */
        window.exitAdminView = function() {
            showMessage("ê´€ë¦¬ì ëª¨ë“œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.", 'blue');
            resetAdminForm();
            showEventList();
        }
        
        // --- 4. Event Detail and Booking Start ---

        /** ì´ë²¤íŠ¸ ìƒì„¸ ë·° í‘œì‹œ */
        window.showEventDetail = async (eventId) => {
            showLoading(true, "ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...");
            hideBookingError();
            
            const eventRef = firebase.doc(db, COLLECTIONS.events, eventId);
            
            try {
                const docSnap = await firebase.getDoc(eventRef);
                if (!docSnap.exists()) {
                    showMessage("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë²¤íŠ¸ì…ë‹ˆë‹¤.", 'error');
                    showEventList();
                    return;
                }

                currentEventData = { id: eventId, ...docSnap.data() };
                
                // ì‹œê°„ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
                const status = getBookingStatus(currentEventData.startTime, currentEventData.endTime);
                
                document.getElementById('detail-title').textContent = currentEventData.title;
                document.getElementById('detail-description').textContent = currentEventData.description;
                document.getElementById('detail-time').textContent = `${formatKstTime(currentEventData.startTime)} ~ ${formatKstTime(currentEventData.endTime)}`;
                
                const statusEl = document.getElementById('detail-status');
                statusEl.textContent = status.status;
                statusEl.className = `kst-badge ${status.color}`;
                
                const startBookingBtn = document.getElementById('start-booking-btn');
                startBookingBtn.disabled = !status.isAvailable;
                startBookingBtn.textContent = status.isAvailable ? 'ì˜ˆë§¤ ì‹œì‘' : `ì˜ˆë§¤ ${status.status}`;
                
                // ë·° ì „í™˜
                setView(views.detail);
                
            } catch (error) {
                console.error("ì´ë²¤íŠ¸ ìƒì„¸ ë¡œë”© ì‹¤íŒ¨:", error);
                showMessage("ì´ë²¤íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'error');
            } finally {
                showLoading(false);
            }
        };

        /** ì˜ˆë§¤ ì‹œì‘ ë²„íŠ¼ í´ë¦­ (ìœ íš¨ì„± ê²€ì‚¬ ë° í ì§„ì…) */
        function handleUserInfoFormSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('input-name').value.trim();
            const studentId = document.getElementById('input-student-id').value.trim();
            const phone = document.getElementById('input-phone').value.trim();
            
            if (!currentEventData) return;
            
            // í•„ìˆ˜ ì •ë³´ ì²´í¬
            if (!name || !studentId || !phone) {
                showMessage("ì´ë¦„, í•™ë²ˆ, ì „í™”ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.", 'warning');
                return;
            }

            const userData = {
                name: name,
                studentId: studentId,
                phone: phone
            };

            enterQueue(currentEventData.id, userData);
        }

        // --- 5. Queue System Core Logic ---

        /** í ëª¨ë‹¬ í‘œì‹œ */
        function showQueueModal(rank, totalUsers) {
            const queueModal = document.getElementById('queue-modal');
            if (!queueModal) return;
            document.getElementById('queue-rank').textContent = rank;
            document.getElementById('queue-behind').textContent = totalUsers > rank ? totalUsers - rank : 0;
            
            const progress = (rank / totalUsers) * 100;
            document.getElementById('queue-progress').style.width = `${100 - progress}%`;

            queueModal.classList.remove('is-hidden');
            queueModal.classList.add('flex');
        }

        /** í ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ëŒ€ê¸°ì—´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸) */
        function setupQueueListener(eventId, userData) {
            if (queueListenerUnsubscribe) queueListenerUnsubscribe(); // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ

            const queueRef = firebase.doc(db, COLLECTIONS.queueStatus, 'status');
            
            queueListenerUnsubscribe = firebase.onSnapshot(queueRef, (docSnap) => {
                if (!docSnap.exists) return;

                const statusData = docSnap.data();
                const activeUsers = statusData.active_users || {};
                const maxConcurrentUsers = statusData.max_concurrent_users || 50;

                // 1. í˜„ì¬ í™œì„± ì‚¬ìš©ì ëª©ë¡ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ì •ë ¬
                const activeUsersArray = Object.entries(activeUsers)
                    .map(([uid, time]) => ({ uid, time: time.toMillis ? time.toMillis() : time }))
                    .sort((a, b) => a.time - b.time);
                
                // 2. í˜„ì¬ ì‚¬ìš©ì ìˆœìœ„ ê³„ì‚°
                const myIndex = activeUsersArray.findIndex(user => user.uid === userId);

                if (myIndex === -1) {
                    // íì—ì„œ ë¹ ì§ (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ íë¥¼ ì •ë¦¬í–ˆê±°ë‚˜, íŠ¸ëœì­ì…˜ ì„±ê³µ í›„ í†µê³¼í–ˆê±°ë‚˜)
                    return;
                }

                // 3. ì§„ì… ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸: ë‚˜ì˜ ì¸ë±ìŠ¤ê°€ ë™ì‹œ ì ‘ì†ì ìˆ˜ë³´ë‹¤ ì‘ë‹¤ë©´ í†µê³¼
                if (myIndex < maxConcurrentUsers) {
                    // í í†µê³¼! íŠ¸ëœì­ì…˜ ì¬ì‹œë„ (ì•ˆì „í•œ ì¬ì§„ì…)
                    if (queueListenerUnsubscribe) {
                        queueListenerUnsubscribe(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
                        queueListenerUnsubscribe = null;
                    }
                    document.getElementById('queue-modal')?.classList.add('is-hidden');
                    showMessage("âœ… ëŒ€ê¸°ì—´ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ì˜ˆë§¤ì°½ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.", 'success');
                    
                    // íŠ¸ëœì­ì…˜ ì„±ê³µ í›„ ì˜ˆë§¤ í™”ë©´ìœ¼ë¡œ ì´ë™
                    setBookingUserData(userData);
                    loadEventBookingUI(eventId);
                } else {
                    // ëŒ€ê¸°ì—´ ì—…ë°ì´íŠ¸
                    const rank = myIndex + 1;
                    const totalUsers = activeUsersArray.length;
                    showQueueModal(rank, totalUsers);
                }

            }, (error) => {
                console.error("Queue Listener Error:", error);
            });
        }

        /**
         * 3. ëŒ€ê¸°ì—´ ì§„ì… ë¡œì§ (Transaction ì‚¬ìš©)
         */
        async function enterQueue(eventId, userData) {
            // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if (isBooking) return;
            isBooking = true; 
            
            showLoading(true, "ëŒ€ê¸°ì—´ ì§„ì… ì¤‘...");
            hideBookingError();
            
            const adminBookingDocRef = firebase.doc(db, COLLECTIONS.adminBookings, eventId + '_' + userData.studentId);

            try {
                const bookingDocSnap = await firebase.getDoc(adminBookingDocRef);
                if (bookingDocSnap.exists()) {
                    showMessage("ì´ë¯¸ ì˜ˆë§¤ëœ í•™ë²ˆì…ë‹ˆë‹¤. ì˜ˆë§¤ ë‚´ì—­ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.", 'warning');
                    isBooking = false;
                    showLoading(false);
                    return;
                }
                
                let isPassedQueue = false;
                let isQueued = false;
                let queueRank = 0;

                await firebase.runTransaction(db, async (transaction) => {
                    const queueRef = firebase.doc(db, COLLECTIONS.queueStatus, 'status');
                    const queueDoc = await transaction.get(queueRef);

                    // ğŸš¨ FIX: ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì´ˆê¸°í™” ğŸš¨
                    let statusData = queueDoc.data();
                    if (!queueDoc.exists) {
                        statusData = {
                            active_users: {},
                            max_concurrent_users: 50,
                        };
                        // Initialize the document in the transaction
                        transaction.set(queueRef, { 
                            ...statusData,
                            last_updated: firebase.serverTimestamp()
                        }, { merge: false });
                        // console.warn("Queue status document was missing and has been initialized.");
                    }
                    // ğŸš¨ END FIX ğŸš¨
                    
                    const activeUsers = statusData.active_users || {};
                    const maxConcurrentUsers = statusData.max_concurrent_users || 50;
                    
                    // 1. í˜„ì¬ í™œì„± ì‚¬ìš©ì ëª©ë¡ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ì •ë ¬
                    const activeUsersArray = Object.entries(activeUsers)
                        .map(([uid, time]) => ({ uid, time: time.toMillis ? time.toMillis() : time }))
                        .sort((a, b) => a.time - b.time);

                    // 2. ë§Œë£Œëœ ì„¸ì…˜ ì •ë¦¬ (10ë¶„ ì´ˆê³¼)
                    const now = Date.now();
                    const expirationTime = 10 * 60 * 1000; // 10 minutes
                    
                    let newActiveUsers = {};
                    let cleanedUsersCount = 0;

                    activeUsersArray.forEach(user => {
                        if (now - user.time < expirationTime) {
                            newActiveUsers[user.uid] = firebase.Timestamp.fromMillis(user.time);
                            cleanedUsersCount++;
                        }
                    });

                    
                    if (cleanedUsersCount < maxConcurrentUsers) {
                        // 3. ì§„ì… í—ˆìš©: active_usersì— ìì‹ ì„ ë“±ë¡
                        
                        // í˜„ì¬ ì‚¬ìš©ì ì¶”ê°€
                        newActiveUsers[userId] = firebase.Timestamp.fromMillis(now);
                        
                        transaction.update(queueRef, {
                            active_users: newActiveUsers,
                            last_updated: firebase.serverTimestamp()
                        });
                        
                        isPassedQueue = true;
                        
                    } else {
                        // 4. ëŒ€ê¸°ì—´ë¡œ ì´ë™
                        isQueued = true;
                        
                        // í˜„ì¬ ì‚¬ìš©ì ìˆœìœ„ ê³„ì‚°
                        const updatedUsersArray = Object.entries(newActiveUsers)
                            .map(([uid, time]) => ({ uid, time: time.toMillis() }))
                            .sort((a, b) => a.time - b.time);

                        queueRank = updatedUsersArray.findIndex(user => user.uid === userId);
                        if (queueRank === -1) {
                            // ìì‹ ì´ íì— ì—†ìœ¼ë©´ ë§¨ ë’¤ë¡œ
                            queueRank = updatedUsersArray.length + 1;
                        } else {
                            queueRank += 1; // 0-based to 1-based
                        }
                        
                        // í ëª¨ë‹¬ í‘œì‹œ ë° onSnapshot ì—°ê²°
                        showQueueModal(queueRank, updatedUsersArray.length);
                        setupQueueListener(eventId, userData); 
                    }
                });

                if (isPassedQueue) {
                    // íŠ¸ëœì­ì…˜ ì„±ê³µ í›„ ì˜ˆë§¤ í™”ë©´ìœ¼ë¡œ ì´ë™
                    setBookingUserData(userData);
                    loadEventBookingUI(eventId);
                } else if (isQueued) {
                    // í ëª¨ë‹¬ì´ ì´ë¯¸ í‘œì‹œë¨
                    // no-op
                } else {
                    // ì´ ì½”ë“œëŠ” íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ ë˜ëŠ” ê¸°íƒ€ ë¡œì§ ì˜¤ë¥˜ ì‹œ ë°œìƒ ê°€ëŠ¥
                    throw new Error("Queue logic failed to resolve to pass or wait state.");
                }

            } catch (error) {
                console.error("ëŒ€ê¸°ì—´ ì§„ì… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                
                // Firestore permission errors or network issues
                let msg = error.message;
                if (error.code === 'permission-denied') {
                    msg = "Firestore ë³´ì•ˆ ê·œì¹™ì— ëŒ€ê¸°ì—´(queue_status) ë¬¸ì„œì— ëŒ€í•œ Public Write ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.";
                } else if (error.code === 'aborted') {
                    msg = "ë™ì‹œ ì ‘ì†ìœ¼ë¡œ ì¸í•´ ëŒ€ê¸°ì—´ ì§„ì…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
                }

                showMessage(`ëŒ€ê¸°ì—´ ì§„ì… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${msg}`, 'error');
            } finally {
                if (!isPassedQueue && !isQueued) {
                    // ì˜ˆì™¸ê°€ ë°œìƒí–ˆê±°ë‚˜, ì˜ˆìƒì¹˜ ëª»í•œ ì¢…ë£Œ ì‹œ ë¡œë”© í•´ì œ
                    isBooking = false; 
                    showLoading(false);
                }
            }
        }

        // --- 6. Booking UI Rendering (Seats/Choices) ---

        /** ì˜ˆë§¤ UI ë¡œë“œ ë° ë Œë”ë§ */
        async function loadEventBookingUI(eventId) {
            if (!currentEventData || currentEventData.id !== eventId) {
                // ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ IDê°€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ë‹¤ì‹œ ë¡œë“œ
                await window.showEventDetail(eventId);
            }
            if (!currentEventData) return; // ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì¢…ë£Œ

            const bookingContentEl = document.getElementById('booking-content');
            bookingContentEl.innerHTML = '<p class="text-center text-gray-500">ì˜ˆë§¤ UI ë¡œë”© ì¤‘...</p>';
            
            try {
                if (currentEventData.type === 'seats') {
                    // ì¢Œì„í˜• ì˜ˆë§¤ UI ë Œë”ë§
                    const seatsCol = firebase.collection(db, COLLECTIONS.events, eventId, 'seats');
                    
                    // onSnapshotìœ¼ë¡œ ì‹¤ì‹œê°„ ì¢Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
                    firebase.onSnapshot(firebase.query(seatsCol, firebase.orderBy('seatId')), (snapshot) => {
                        renderSeatsUI(eventId, snapshot);
                    });

                } else if (currentEventData.type === 'choices') {
                    // ì„ íƒí˜• ì˜ˆë§¤ UI ë Œë”ë§
                    const choicesCol = firebase.collection(db, COLLECTIONS.events, eventId, 'choices');
                    
                    // onSnapshotìœ¼ë¡œ ì‹¤ì‹œê°„ ì„ íƒì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
                    firebase.onSnapshot(choicesCol, (snapshot) => {
                        renderChoicesUI(eventId, snapshot);
                    });
                }
                
                setView(views.booking);
                showLoading(false);

            } catch (error) {
                console.error("ì˜ˆë§¤ UI ë¡œë”© ì‹¤íŒ¨:", error);
                showMessage("ì˜ˆë§¤ í™”ë©´ì„ êµ¬ì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'error');
                showEventList();
            }
        }

        /** ì¢Œì„ UI ë Œë”ë§ */
        function renderSeatsUI(eventId, snapshot) {
            const bookingContentEl = document.getElementById('booking-content');
            let seatsHtml = '';
            
            snapshot.forEach(doc => {
                const seat = doc.data();
                const seatId = doc.id;
                const isBooked = seat.isBooked;
                const isMine = seat.bookingId === bookingUserData.studentId;

                const className = isBooked 
                    ? (isMine ? 'bg-blue-500 text-white cursor-pointer hover:bg-blue-600' : 'bg-red-500 text-white cursor-not-allowed')
                    : 'bg-green-500 text-white cursor-pointer hover:bg-green-600';
                
                seatsHtml += `
                    <div class="seat ${className}" 
                         data-seat-id="${seatId}" 
                         onclick="handleSeatSelection('${eventId}', '${seatId}', ${isBooked}, ${isMine})">
                        ${seatId}
                    </div>
                `;
            });
            
            bookingContentEl.innerHTML = `
                <div class="text-center mb-4">
                    <p class="inline-block px-3 py-1 text-sm rounded-full bg-green-200 text-green-800">ì„ íƒ ê°€ëŠ¥</p>
                    <p class="inline-block px-3 py-1 text-sm rounded-full bg-red-200 text-red-800">ì˜ˆë§¤ ì™„ë£Œ</p>
                    <p class="inline-block px-3 py-1 text-sm rounded-full bg-blue-200 text-blue-800">ë‚˜ì˜ ì„ íƒ</p>
                </div>
                <div class="seat-grid">${seatsHtml}</div>
                <button id="confirm-seat-booking-btn" class="w-full mt-6 p-3 rounded-lg btn-primary" onclick="confirmBooking('${eventId}', 'seat')">ì˜ˆë§¤ ì™„ë£Œ</button>
                <div id="selected-seat-info" class="mt-4 text-center font-semibold text-gray-700">ì¢Œì„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
            `;

            // ì¢Œì„ ì„ íƒ ìƒíƒœ ë³µì› (ë‹¨ì¼ ì„ íƒ ê°€ì •)
            const myBookedSeat = snapshot.docs.find(doc => doc.data().bookingId === bookingUserData.studentId);
            const infoEl = document.getElementById('selected-seat-info');
            if (myBookedSeat) {
                const seatId = myBookedSeat.id;
                if (infoEl) {
                    infoEl.textContent = `ì„ íƒëœ ì¢Œì„: ${seatId}`;
                    infoEl.dataset.selectedId = seatId; // ìƒíƒœ ì €ì¥
                }
            } else {
                if (infoEl) infoEl.dataset.selectedId = '';
            }
        }

        /** ì¢Œì„ ì„ íƒ í•¸ë“¤ëŸ¬ */
        window.handleSeatSelection = async (eventId, seatId, isBooked, isMine) => {
            if (isBooked && !isMine) {
                showMessage(`ì¢Œì„ ${seatId}ëŠ” ì´ë¯¸ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'warning');
                return;
            }
            if (isBooking) return; // íŠ¸ëœì­ì…˜ ì¤‘ë³µ ë°©ì§€

            isBooking = true;
            showLoading(true, "ì¢Œì„ ì„ íƒ ì²˜ë¦¬ ì¤‘...");
            
            try {
                await firebase.runTransaction(db, async (transaction) => {
                    const seatRef = firebase.doc(db, COLLECTIONS.events, eventId, 'seats', seatId);
                    const seatDoc = await transaction.get(seatRef);
                    
                    if (!seatDoc.exists()) throw new Error("Seat not found.");

                    const seatData = seatDoc.data();
                    const infoEl = document.getElementById('selected-seat-info');
                    const currentlySelectedSeatId = infoEl?.dataset.selectedId;

                    if (seatData.isBooked && seatData.bookingId === bookingUserData.studentId) {
                        // 1. ìì‹ ì˜ ì¢Œì„ì„ í•´ì œ
                        transaction.update(seatRef, {
                            isBooked: false,
                            bookingId: null,
                        });
                        if (infoEl) {
                            infoEl.dataset.selectedId = '';
                            infoEl.textContent = 'ì¢Œì„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.';
                        }
                        showMessage(`ì¢Œì„ ${seatId}ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

                    } else if (seatData.isBooked) {
                        // 2. ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ëŒì´ ì˜ˆì•½
                        throw new Error(`ì¢Œì„ ${seatId}ëŠ” ì´ë¯¸ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                    } else {
                        // 3. ìƒˆ ì¢Œì„ ì„ íƒ (ê¸°ì¡´ ì„ íƒ í•´ì œ í•„ìš”)

                        // 3-a. ê¸°ì¡´ ì„ íƒ ì¢Œì„ í•´ì œ
                        if (currentlySelectedSeatId && currentlySelectedSeatId !== seatId) {
                            const prevSeatRef = firebase.doc(db, COLLECTIONS.events, eventId, 'seats', currentlySelectedSeatId);
                            transaction.update(prevSeatRef, {
                                isBooked: false,
                                bookingId: null,
                            });
                        }

                        // 3-b. ìƒˆ ì¢Œì„ ì˜ˆì•½
                        transaction.update(seatRef, {
                            isBooked: true,
                            bookingId: bookingUserData.studentId, // í•™ë²ˆì„ ì„ì‹œ ì˜ˆë§¤ IDë¡œ ì‚¬ìš©
                        });
                        
                        if (infoEl) {
                            infoEl.dataset.selectedId = seatId;
                            infoEl.textContent = `ì„ íƒëœ ì¢Œì„: ${seatId}`;
                        }
                        showMessage(`ì¢Œì„ ${seatId}ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    }
                });
            } catch (error) {
                console.error("Seat selection failed:", error);
                showMessage(`ì¢Œì„ ì„ íƒ ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                isBooking = false;
                showLoading(false);
            }
        };


        /** ì„ íƒì§€ UI ë Œë”ë§ */
        function renderChoicesUI(eventId, snapshot) {
            const bookingContentEl = document.getElementById('booking-content');
            let choicesHtml = '';
            let isMineBooked = false; // í˜„ì¬ ì‚¬ìš©ìê°€ ì˜ˆë§¤í–ˆëŠ”ì§€ ì—¬ë¶€ (ì„ íƒí˜•ì€ ë‹¨ì¼ ì˜ˆë§¤ ê°€ì •)

            const choicesArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // 1. ìì‹ ì˜ ì˜ˆë§¤ ë‚´ì—­ì„ ì°¾ëŠ”ë‹¤ (adminBookingsì—ì„œ í™•ì¸)
            const checkBooking = async () => {
                const adminBookingRef = firebase.doc(db, COLLECTIONS.adminBookings, eventId + '_' + bookingUserData.studentId);
                const snap = await firebase.getDoc(adminBookingRef);
                return snap.exists;
            }

            checkBooking().then(exists => {
                isMineBooked = exists;

                choicesArray.forEach(choice => {
                    const remaining = choice.limit - choice.count;
                    const isFull = remaining <= 0;
                    
                    const buttonText = isMineBooked ? "ì˜ˆë§¤ ì™„ë£Œë¨" : (isFull ? "ë§¤ì§„" : `ì˜ˆë§¤ (${remaining}ì„ ë‚¨ìŒ)`);
                    
                    const buttonClass = isMineBooked 
                        ? 'bg-blue-500 text-white cursor-default'
                        : (isFull ? 'bg-gray-400 text-white cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600');

                    choicesHtml += `
                        <div class="p-4 border rounded-lg flex justify-between items-center shadow-sm bg-white">
                            <div>
                                <h4 class="font-semibold text-lg">${choice.name}</h4>
                                <p class="text-sm text-gray-600">ì´ ì •ì›: ${choice.limit}ëª…</p>
                            </div>
                            <button 
                                class="p-2 rounded-lg text-sm transition-colors ${buttonClass}" 
                                data-choice-id="${choice.id}"
                                ${isFull || isMineBooked ? 'disabled' : ''}
                                onclick="handleChoiceBooking('${eventId}', '${choice.id}')">
                                ${buttonText}
                            </button>
                        </div>
                    `;
                });

                bookingContentEl.innerHTML = `
                    <p class="mb-4 text-gray-700">ì•„ë˜ ì˜µì…˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì˜ˆë§¤ë¥¼ ì§„í–‰í•˜ì„¸ìš”.</p>
                    <div class="space-y-3">
                        ${choicesHtml}
                    </div>
                `;
            });
        }

        /** ì„ íƒí˜• ì˜ˆë§¤ ì²˜ë¦¬ */
        window.handleChoiceBooking = async (eventId, choiceId) => {
            if (isBooking) return;
            isBooking = true;
            showLoading(true, "ì˜ˆë§¤ ì²˜ë¦¬ ì¤‘...");

            try {
                // 1. ì¤‘ë³µ ì˜ˆë§¤ í™•ì¸ì€ `user-info-form` ì œì¶œ ì‹œ ì§„í–‰ë¨. ì—¬ê¸°ì„œëŠ” ìµœì¢… í™•ì¸.
                const adminBookingDocRef = firebase.doc(db, COLLECTIONS.adminBookings, eventId + '_' + bookingUserData.studentId);
                const bookingDocSnap = await firebase.getDoc(adminBookingDocRef);
                if (bookingDocSnap.exists()) {
                    showMessage("ì´ë¯¸ ì˜ˆë§¤ëœ í•™ë²ˆì…ë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€)", 'warning');
                    isBooking = false;
                    showLoading(false);
                    return;
                }
                
                await firebase.runTransaction(db, async (transaction) => {
                    const choiceRef = firebase.doc(db, COLLECTIONS.events, eventId, 'choices', choiceId);
                    const choiceDoc = await transaction.get(choiceRef);

                    if (!choiceDoc.exists()) throw new Error("Choice not found.");

                    const choiceData = choiceDoc.data();
                    if (choiceData.count >= choiceData.limit) {
                        throw new Error("ë§¤ì§„ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì˜µì…˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                    }

                    // 2. ì„ íƒì§€ ì¹´ìš´íŠ¸ ì¦ê°€
                    transaction.update(choiceRef, {
                        count: firebase.FieldValue.increment(1)
                    });

                    // 3. ì˜ˆë§¤ ê¸°ë¡ (Admin & User)
                    const bookingData = {
                        eventId: eventId,
                        eventTitle: currentEventData.title,
                        type: 'choice',
                        bookingRefId: choiceId, // ì„ íƒì§€ ID ì €ì¥
                        refName: choiceData.name,
                        name: bookingUserData.name,
                        studentId: bookingUserData.studentId,
                        phone: bookingUserData.phone,
                        timestamp: firebase.serverTimestamp(),
                        userId: userId
                    };
                    
                    const bookingRef = firebase.doc(firebase.collection(db, COLLECTIONS.bookings), choiceId);
                    const adminBookingRef = firebase.doc(db, COLLECTIONS.adminBookings, eventId + '_' + bookingUserData.studentId);
                    
                    transaction.set(bookingRef, bookingData);
                    transaction.set(adminBookingRef, bookingData);
                });

                showBookingCompleteModal(bookingUserData.studentId, bookingUserData.name, 'ì„ íƒ ì™„ë£Œ');

            } catch (error) {
                console.error("Choice booking failed:", error);
                showMessage(`ì˜ˆë§¤ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                isBooking = false;
                showLoading(false);
            }
        };
        
        // --- 7. Booking Confirmation and Completion ---

        /** ìµœì¢… ì˜ˆë§¤ ì™„ë£Œ (ì¢Œì„í˜• ì „ìš©) */
        window.confirmBooking = async (eventId, type) => {
            if (type !== 'seat') return;
            
            const infoEl = document.getElementById('selected-seat-info');
            const selectedSeatId = infoEl?.dataset.selectedId;

            if (!selectedSeatId) {
                showMessage("ì˜ˆì•½í•  ì¢Œì„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.", 'warning');
                return;
            }
            if (isBooking) return;

            isBooking = true;
            showLoading(true, `ì¢Œì„ ${selectedSeatId} ìµœì¢… ì˜ˆë§¤ ì¤‘...`);
            
            try {
                // 1. ì¤‘ë³µ ì˜ˆë§¤ í™•ì¸
                const adminBookingDocRef = firebase.doc(db, COLLECTIONS.adminBookings, eventId + '_' + bookingUserData.studentId);
                const bookingDocSnap = await firebase.getDoc(adminBookingDocRef);
                if (bookingDocSnap.exists()) {
                    showMessage("ì´ë¯¸ ì˜ˆë§¤ëœ í•™ë²ˆì…ë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€)", 'warning');
                    isBooking = false;
                    showLoading(false);
                    return;
                }
                
                await firebase.runTransaction(db, async (transaction) => {
                    const seatRef = firebase.doc(db, COLLECTIONS.events, eventId, 'seats', selectedSeatId);
                    const seatDoc = await transaction.get(seatRef);

                    if (!seatDoc.exists()) throw new Error("Seat not found.");
                    const seatData = seatDoc.data();
                    
                    // 2. ì¢Œì„ì´ ì•„ì§ ë‚˜ì˜ ì„ì‹œ ì˜ˆì•½ ìƒíƒœì¸ì§€ í™•ì¸ (íŠ¸ëœì­ì…˜ ë„ì¤‘ ìƒíƒœ ë³€ê²½ ë°©ì§€)
                    if (seatData.isBooked && seatData.bookingId !== bookingUserData.studentId) {
                         throw new Error(`ì¢Œì„ ${selectedSeatId}ëŠ” ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ëŒì— ì˜í•´ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                    if (!seatData.isBooked) {
                        throw new Error(`ì¢Œì„ ${selectedSeatId}ê°€ ì„ íƒë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.`);
                    }

                    // 3. ì˜ˆë§¤ ê¸°ë¡ (Admin & User)
                    const bookingData = {
                        eventId: eventId,
                        eventTitle: currentEventData.title,
                        type: 'seat',
                        bookingRefId: selectedSeatId, // ì¢Œì„ ID ì €ì¥
                        refName: selectedSeatId,
                        name: bookingUserData.name,
                        studentId: bookingUserData.studentId,
                        phone: bookingUserData.phone,
                        timestamp: firebase.serverTimestamp(),
                        userId: userId
                    };
                    
                    const bookingRef = firebase.doc(firebase.collection(db, COLLECTIONS.bookings), selectedSeatId);
                    const adminBookingRef = firebase.doc(db, COLLECTIONS.adminBookings, eventId + '_' + bookingUserData.studentId);
                    
                    transaction.set(bookingRef, bookingData);
                    transaction.set(adminBookingRef, bookingData);
                });

                showBookingCompleteModal(bookingUserData.studentId, bookingUserData.name, selectedSeatId);

            } catch (error) {
                console.error("Seat booking confirmation failed:", error);
                showMessage(`ì˜ˆë§¤ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                isBooking = false;
                showLoading(false);
            }
        };

        /** ì˜ˆë§¤ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ */
        function showBookingCompleteModal(studentId, name, bookingRef) {
            const modalEl = document.getElementById('complete-modal');
            if (!modalEl) return;
            document.getElementById('complete-student-id').textContent = studentId;
            document.getElementById('complete-name').textContent = name;
            document.getElementById('complete-booking-number').textContent = bookingRef;
            
            modalEl.classList.remove('is-hidden');
        }
        window.showBookingCompleteModal = showBookingCompleteModal;


        // --- 8. My Booking Check and Cancel ---

        /** ì˜ˆë§¤ ë‚´ì—­ ì¡°íšŒ */
        function handleCheckBookingFormSubmit(e) {
            e.preventDefault();
            const studentId = document.getElementById('check-student-id').value.trim();
            const bookingRefId = document.getElementById('check-booking-number').value.trim(); // ì¢Œì„ID ë˜ëŠ” ì„ íƒì§€ID
            const resultEl = document.getElementById('checked-booking-result');
            const errorEl = document.getElementById('check-error-msg');
            
            resultEl?.classList.add('hidden');
            errorEl?.classList.add('hidden');
            showLoading(true, "ì˜ˆë§¤ ë‚´ì—­ ì¡°íšŒ ì¤‘...");

            checkBooking(studentId, bookingRefId, resultEl, errorEl);
        }

        async function checkBooking(studentId, bookingRefId, resultEl, errorEl) {
            try {
                // 1. ìœ ì €ì˜ ê°œì¸ bookings ì»¬ë ‰ì…˜ì—ì„œ ì¡°íšŒ
                if (!COLLECTIONS.bookings) {
                    errorEl.textContent = "ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                    errorEl.classList.remove('hidden');
                    return;
                }

                const bookingQuery = firebase.query(
                    firebase.collection(db, COLLECTIONS.bookings), 
                    firebase.where('studentId', '==', studentId), 
                    firebase.where('bookingRefId', '==', bookingRefId),
                    firebase.limit(1)
                );
                const querySnapshot = await firebase.getDocs(bookingQuery);
                
                if (querySnapshot.empty) {
                    errorEl.textContent = "ì¼ì¹˜í•˜ëŠ” ì˜ˆë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. í•™ë²ˆê³¼ ì˜ˆë§¤ë²ˆí˜¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                    errorEl.classList.remove('hidden');
                    return;
                }

                const bookingDoc = querySnapshot.docs[0];
                const booking = bookingDoc.data();
                const bookingId = bookingDoc.id;
                
                const eventRef = firebase.doc(db, COLLECTIONS.events, booking.eventId);
                const eventSnap = await firebase.getDoc(eventRef);
                const eventTitle = eventSnap.exists() ? eventSnap.data().title : 'ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸';

                if (resultEl) {
                    resultEl.innerHTML = `
                        <p class="font-bold text-lg text-blue-700 mb-2">ì˜ˆë§¤ ë‚´ì—­ í™•ì¸ë¨</p>
                        <p><strong>ì´ë²¤íŠ¸:</strong> ${eventTitle}</p>
                        <p><strong>ì˜ˆë§¤ì:</strong> ${booking.name} (${booking.studentId})</p>
                        <p><strong>ì„ íƒ í•­ëª©:</strong> ${booking.refName} (${booking.type === 'seat' ? 'ì¢Œì„í˜•' : 'ì„ íƒí˜•'})</p>
                        <p class="text-xs text-gray-500">ì˜ˆë§¤ ì‹œê°: ${formatKstTime(booking.timestamp)}</p>
                        <button onclick="cancelBooking('${booking.eventId}', '${booking.type}', '${booking.bookingRefId}', '${booking.studentId}')" 
                                class="w-full mt-4 p-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">
                            ì˜ˆë§¤ ì·¨ì†Œ
                        </button>
                    `;
                    resultEl.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Booking check failed:", error);
                if (errorEl) {
                    errorEl.textContent = `ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`;
                    errorEl.classList.remove('hidden');
                }
            } finally {
                showLoading(false);
            }
        }


        /** ì˜ˆë§¤ ì·¨ì†Œ (Transaction ì‚¬ìš©) */
        window.cancelBooking = async (eventId, type, bookingRefId, studentId) => {
            if (isBooking) return;
            isBooking = true;
            
            showLoading(true, "ì˜ˆë§¤ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘...");
            
            try {
                await firebase.runTransaction(db, async (transaction) => {
                    // 1. Admin Bookings ì‚­ì œ (ê°€ì¥ ë¨¼ì €)
                    const adminBookingRef = firebase.doc(db, COLLECTIONS.adminBookings, eventId + '_' + studentId);
                    transaction.delete(adminBookingRef);
                    
                    // 2. User Bookings ì‚­ì œ (COLLECTIONS.bookingsê°€ nullì´ ì•„ë‹Œì§€ í™•ì¸)
                    if (COLLECTIONS.bookings) {
                        const userBookingRef = firebase.doc(firebase.collection(db, COLLECTIONS.bookings), bookingRefId);
                        transaction.delete(userBookingRef);
                    }


                    // 3. ì´ë²¤íŠ¸ ìƒíƒœ ë³µêµ¬
                    if (type === 'choice') {
                        // ì„ íƒí˜•: count ê°ì†Œ (bookingRefIdëŠ” choice ID)
                        const choiceRef = firebase.doc(db, COLLECTIONS.events, eventId, 'choices', bookingRefId);
                        transaction.update(choiceRef, { 
                            count: firebase.FieldValue.increment(-1)
                        });
                        
                    } else if (type === 'seat') {
                        // ì¢Œì„í˜•: isBooked í•´ì œ (bookingRefIdëŠ” seat ID)
                        const seatRef = firebase.doc(db, COLLECTIONS.events, eventId, 'seats', bookingRefId);
                        transaction.update(seatRef, { 
                            isBooked: false,
                            bookingId: null,
                        });
                    }
                });
                
                showMessage("âœ… ì˜ˆë§¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('checked-booking-result')?.classList.add('hidden');
                document.getElementById('check-booking-form')?.reset();
                
            } catch (error) {
                console.error("Cancellation Error:", error);
                showMessage(`ì·¨ì†Œ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                isBooking = false;
                showLoading(false);
            }
        };

        // --- 9. Admin Functions (CRUD, Delete Booking) ---

        /** ê´€ë¦¬ì ëª¨ë“œ ì´ë²¤íŠ¸ ëª©ë¡ ë¡œë“œ (onSnapshotìœ¼ë¡œ ì‹¤ì‹œê°„) */
        function loadAdminEvents() {
            const eventsCol = firebase.collection(db, COLLECTIONS.events);
            const adminEventListEl = document.getElementById('admin-event-list');
            
            if (!adminEventListEl) return;

            // í ë¦¬ìŠ¤ë„ˆ í•´ì œ (ê´€ë¦¬ì ëª¨ë“œëŠ” ë³„ë„ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©)
            if (queueListenerUnsubscribe) {
                queueListenerUnsubscribe();
                queueListenerUnsubscribe = null;
            }

            firebase.onSnapshot(eventsCol, (snapshot) => {
                adminEventListEl.innerHTML = '';
                if (snapshot.empty) {
                    adminEventListEl.innerHTML = '<p class="text-center text-gray-500">ë“±ë¡ëœ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const event = doc.data();
                    const eventId = doc.id;
                    const kstStart = formatKstTime(event.startTime);
                    
                    const item = `
                        <div class="p-4 border rounded-lg bg-white flex justify-between items-center shadow-sm">
                            <div>
                                <p class="font-semibold text-lg text-gray-800">${event.title} <span class="text-sm text-gray-500">(${event.type === 'seats' ? 'ì¢Œì„í˜•' : 'ì„ íƒí˜•'})</span></p>
                                <p class="text-xs text-gray-500">ID: ${eventId}</p>
                                <p class="text-sm text-blue-600">ì‹œì‘: ${kstStart}</p>
                            </div>
                            <div class="space-x-2 flex items-center">
                                <button onclick="startEditEvent('${eventId}')" class="p-2 text-sm bg-yellow-500 text-white rounded hover:bg-yellow-600">ìˆ˜ì •</button>
                                <button onclick="deleteEvent('${eventId}')" class="p-2 text-sm bg-red-500 text-white rounded hover:bg-red-600">ì‚­ì œ</button>
                                <button onclick="showAdminBookingSearchModal('${eventId}', '${event.title}')" class="p-2 text-sm bg-indigo-500 text-white rounded hover:bg-indigo-600">ì˜ˆë§¤ ì‚­ì œ</button>
                            </div>
                        </div>
                    `;
                    adminEventListEl.insertAdjacentHTML('beforeend', item);
                });
            }, (error) => {
                console.error("ê´€ë¦¬ì ì´ë²¤íŠ¸ ë¡œë”© ì‹¤íŒ¨:", error);
                adminEventListEl.innerHTML = '<p class="text-center text-red-500">ì´ë²¤íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            });
        }
        
        /** í¼ ì´ˆê¸°í™” */
        window.resetAdminForm = function() {
            editingEventId = null;
            document.getElementById('create-event-form')?.reset();
            document.getElementById('admin-form-mode').textContent = "ìƒˆ ì´ë²¤íŠ¸ ìƒì„± ëª¨ë“œ";
            document.getElementById('create-event-button').textContent = "ì´ë²¤íŠ¸ ìƒì„±";
            document.getElementById('admin-error-msg')?.classList.add('hidden');
            // ì„ íƒí˜• UI ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì •
            const adminTypeEl = document.getElementById('admin-type');
            if (adminTypeEl) {
                adminTypeEl.value = 'choices';
                adminTypeEl.dispatchEvent(new Event('change'));
            }
        }

        /** ì´ë²¤íŠ¸ ìˆ˜ì • ì‹œì‘ */
        window.startEditEvent = async function(eventId) {
            showLoading(true, "ì´ë²¤íŠ¸ ë°ì´í„° ë¡œë”© ì¤‘...");
            try {
                const eventRef = firebase.doc(db, COLLECTIONS.events, eventId);
                const eventSnap = await firebase.getDoc(eventRef);

                if (!eventSnap.exists()) {
                    showMessage("ìˆ˜ì •í•  ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
                    return;
                }

                const event = eventSnap.data();
                editingEventId = eventId;
                
                document.getElementById('admin-form-mode').textContent = `ì´ë²¤íŠ¸ ìˆ˜ì • ëª¨ë“œ (ID: ${eventId})`;
                document.getElementById('create-event-button').textContent = "ìˆ˜ì • ì™„ë£Œ";
                
                document.getElementById('admin-title').value = event.title;
                document.getElementById('admin-description').value = event.description;
                
                // Firestore Timestamp to datetime-local format
                const startTimeISO = event.startTime.toDate().toISOString().slice(0, 16);
                const endTimeISO = event.endTime.toDate().toISOString().slice(0, 16);
                document.getElementById('admin-start-time').value = startTimeISO;
                document.getElementById('admin-end-time').value = endTimeISO;
                
                const adminTypeEl = document.getElementById('admin-type');
                if (adminTypeEl) {
                    adminTypeEl.value = event.type;
                    adminTypeEl.dispatchEvent(new Event('change')); // UI ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
                }


                const configEl = document.getElementById('admin-type-config');
                if (!configEl) return;

                if (event.type === 'seats') {
                    // ì¢Œì„í˜•ì€ ìˆ˜ì • ë¶ˆê°€ (ì¢Œì„ ë°ì´í„°ëŠ” ìˆ˜ë™ ìˆ˜ì • í•„ìš”)
                    configEl.innerHTML = `<p class="text-red-500 font-bold">ì¢Œì„ ì •ë³´ëŠ” ìƒì„± í›„ Firestore ì½˜ì†”ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>`;
                } else if (event.type === 'choices') {
                    const choicesCol = firebase.collection(db, COLLECTIONS.events, eventId, 'choices');
                    const choicesSnap = await firebase.getDocs(choicesCol);
                    
                    const container = document.getElementById('choices-container');
                    if (container) container.innerHTML = '';
                    
                    choicesSnap.forEach(doc => {
                        const choice = doc.data();
                        const choiceId = doc.id;
                        if (container) {
                             container.insertAdjacentHTML('beforeend', `
                                <div class="flex gap-2 choice-option" data-choice-id="${choiceId}">
                                    <input type="text" placeholder="ì˜µì…˜ ì´ë¦„" class="flex-grow p-2 border rounded choice-name" value="${choice.name}">
                                    <input type="number" placeholder="ì •ì›" min="1" class="w-20 p-2 border rounded choice-limit" value="${choice.limit}">
                                    <p class="w-20 p-2 text-sm text-gray-600">ì˜ˆë§¤ ìˆ˜: ${choice.count}</p>
                                    <button type="button" onclick="removeChoiceOption(this, '${choiceId}')" class="text-red-500">X</button>
                                </div>
                            `);
                        }
                    });
                }
                
                // ë·° ì´ë™
                document.getElementById('admin-view')?.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Edit load failed:", error);
                showMessage(`ìˆ˜ì • ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        /** ì´ë²¤íŠ¸ ì‚­ì œ */
        window.deleteEvent = function(eventId) {
            showGlobalModal(true, "ğŸš¨ ì´ë²¤íŠ¸ ì‚­ì œ í™•ì¸", 
                `<p>ì •ë§ë¡œ ì´ë²¤íŠ¸ ID <strong>${eventId}</strong>ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì˜ˆë§¤ ë‚´ì—­ê³¼ í•˜ìœ„ ë°ì´í„°(ì¢Œì„/ì„ íƒì§€)ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.</p>`,
                `<button onclick="confirmDeleteEvent('${eventId}')" class="p-2 rounded bg-red-600 text-white hover:bg-red-700">ì˜êµ¬ ì‚­ì œ</button>
                 <button onclick="showGlobalModal(false)" class="p-2 rounded bg-gray-300 ml-2">ì·¨ì†Œ</button>`
            );
        }

        /** ì´ë²¤íŠ¸ ì‚­ì œ í™•ì • */
        window.confirmDeleteEvent = async function(eventId) {
            showGlobalModal(false);
            showLoading(true, "ì´ë²¤íŠ¸ ë° ëª¨ë“  ë°ì´í„° ì‚­ì œ ì¤‘...");

            try {
                const eventRef = firebase.doc(db, COLLECTIONS.events, eventId);
                const batch = firebase.writeBatch(db); // For deleting all records

                // 1. í•˜ìœ„ ì»¬ë ‰ì…˜ ì‚­ì œ (ì„ íƒì§€ ë° ì¢Œì„)
                
                const deleteSubcollection = async (subcollectionPath) => {
                    const colRef = firebase.collection(db, COLLECTIONS.events, eventId, subcollectionPath);
                    const snapshot = await firebase.getDocs(colRef);
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                };

                await deleteSubcollection('choices');
                await deleteSubcollection('seats');

                // 2. ì˜ˆë§¤ ë‚´ì—­ ì‚­ì œ (adminBookings)
                
                // Delete Admin Bookings related to this event
                const adminBookingsQuery = firebase.query(firebase.collection(db, COLLECTIONS.adminBookings), firebase.where('eventId', '==', eventId));
                const adminBookingsSnap = await firebase.getDocs(adminBookingsQuery);
                adminBookingsSnap.docs.forEach(doc => batch.delete(doc.ref));

                // 3. ë©”ì¸ ì´ë²¤íŠ¸ ë¬¸ì„œ ì‚­ì œ
                batch.delete(eventRef);

                await batch.commit();

                showMessage(`âœ… ì´ë²¤íŠ¸ ID ${eventId}ê°€ ì˜êµ¬ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                resetAdminForm(); // í¼ ì´ˆê¸°í™”
                
            } catch (error) {
                console.error("Deletion failed:", error);
                showMessage(`ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // --- Admin Form Logic ---
        
        /** ì´ë²¤íŠ¸ ìƒì„±/ìˆ˜ì • ì œì¶œ í•¸ë“¤ëŸ¬ */
        window.handleCreateEventFormSubmit = async function(e) {
            e.preventDefault();

            const title = document.getElementById('admin-title').value.trim();
            const description = document.getElementById('admin-description').value.trim();
            const startTimeLocal = document.getElementById('admin-start-time').value;
            const endTimeLocal = document.getElementById('admin-end-time').value;
            const type = document.getElementById('admin-type').value;

            const startTime = getKstTimestamp(startTimeLocal);
            const endTime = getKstTimestamp(endTimeLocal);
            const errorEl = document.getElementById('admin-error-msg');
            errorEl.classList.add('hidden');
            
            if (!title || !description || !startTime || !endTime) {
                errorEl.textContent = "ëª¨ë“  í•„ìˆ˜ í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”.";
                errorEl.classList.remove('hidden');
                return;
            }

            if (startTime.seconds >= endTime.seconds) {
                errorEl.textContent = "ì˜ˆë§¤ ì¢…ë£Œ ì‹œê°ì€ ì‹œì‘ ì‹œê°ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.";
                errorEl.classList.remove('hidden');
                return;
            }

            showLoading(true, editingEventId ? "ì´ë²¤íŠ¸ ìˆ˜ì • ì¤‘..." : "ì´ë²¤íŠ¸ ìƒì„± ì¤‘...");

            try {
                const eventRef = editingEventId 
                    ? firebase.doc(db, COLLECTIONS.events, editingEventId)
                    : firebase.doc(firebase.collection(db, COLLECTIONS.events));
                
                const eventData = {
                    title,
                    description,
                    startTime,
                    endTime,
                    type,
                    updatedAt: firebase.serverTimestamp()
                };

                // 1. ì´ë²¤íŠ¸ ë¬¸ì„œ ìƒì„±/ì—…ë°ì´íŠ¸
                await firebase.setDoc(eventRef, eventData, { merge: true });
                const currentEventId = eventRef.id;

                // 2. í•˜ìœ„ ì»¬ë ‰ì…˜ ì²˜ë¦¬ (Seats or Choices)
                if (!editingEventId) { // ìƒˆ ì´ë²¤íŠ¸ ìƒì„± ì‹œì—ë§Œ ì´ˆê¸° ë°ì´í„° ì„¤ì •
                    if (type === 'seats') {
                        // ê¸°ë³¸ 20ê°œ ì¢Œì„ ìƒì„± (A1~A10, B1~B10)
                        const batch = firebase.writeBatch(db);
                        for (let i = 1; i <= 10; i++) {
                            batch.set(firebase.doc(db, COLLECTIONS.events, currentEventId, 'seats', `A${i}`), { seatId: `A${i}`, isBooked: false, bookingId: null });
                            batch.set(firebase.doc(db, COLLECTIONS.events, currentEventId, 'seats', `B${i}`), { seatId: `B${i}`, isBooked: false, bookingId: null });
                        }
                        await batch.commit();
                    } else if (type === 'choices') {
                        // ì„ íƒí˜• ì˜µì…˜ ì²˜ë¦¬
                        const choiceOptions = document.querySelectorAll('#choices-container .choice-option');
                        if (choiceOptions.length === 0) {
                            throw new Error("ì„ íƒí˜• ì´ë²¤íŠ¸ëŠ” ìµœì†Œ í•˜ë‚˜ì˜ ì˜µì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        }
                        
                        const batch = firebase.writeBatch(db);
                        choiceOptions.forEach((option, index) => {
                            const name = option.querySelector('.choice-name').value.trim() || `ì˜µì…˜ ${index + 1}`;
                            const limit = parseInt(option.querySelector('.choice-limit').value, 10) || 10;
                            const choiceId = option.dataset.choiceId || firebase.doc(firebase.collection(db, COLLECTIONS.events, currentEventId, 'choices')).id;
                            
                            batch.set(firebase.doc(db, COLLECTIONS.events, currentEventId, 'choices', choiceId), { 
                                name, 
                                limit, 
                                count: 0,
                                createdAt: firebase.serverTimestamp()
                            });
                        });
                        await batch.commit();
                    }
                } else if (type === 'choices') {
                     // ìˆ˜ì • ëª¨ë“œ: ì„ íƒí˜• ì˜µì…˜ ì—…ë°ì´íŠ¸
                    const choiceOptions = document.querySelectorAll('#choices-container .choice-option');
                    
                    const batch = firebase.writeBatch(db);
                    choiceOptions.forEach((option, index) => {
                        const name = option.querySelector('.choice-name').value.trim() || `ì˜µì…˜ ${index + 1}`;
                        const limit = parseInt(option.querySelector('.choice-limit').value, 10) || 10;
                        const choiceId = option.dataset.choiceId; // ê¸°ì¡´ ID ì‚¬ìš©

                        if (choiceId) {
                            batch.update(firebase.doc(db, COLLECTIONS.events, currentEventId, 'choices', choiceId), { 
                                name, 
                                limit, 
                                updatedAt: firebase.serverTimestamp()
                            });
                        }
                        // ìƒˆë¡œ ì¶”ê°€ëœ ì˜µì…˜ì€ í˜„ì¬ ë¡œì§ì—ì„œëŠ” ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (ìƒì„± ëª¨ë“œì™€ í†µí•© í•„ìš”)
                    });
                    await batch.commit();
                }

                showMessage(`âœ… ì´ë²¤íŠ¸ ${editingEventId ? 'ìˆ˜ì •' : 'ìƒì„±'} ì™„ë£Œ: ${title}`, 'success');
                resetAdminForm();
                
            } catch (error) {
                console.error("Event CRUD failed:", error);
                errorEl.textContent = `ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`;
                errorEl.classList.remove('hidden');
            } finally {
                showLoading(false);
            }
        }
        
        /** ì„ íƒí˜• ì˜µì…˜ UI ì¶”ê°€ */
        window.addChoiceOption = function() {
            const container = document.getElementById('choices-container');
            if (container) {
                const newId = crypto.randomUUID();
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex gap-2 choice-option" data-choice-id="${newId}">
                        <input type="text" placeholder="ì˜µì…˜ ì´ë¦„" class="flex-grow p-2 border rounded choice-name">
                        <input type="number" placeholder="ì •ì›" min="1" class="w-20 p-2 border rounded choice-limit" value="10">
                        <p class="w-20 p-2 text-sm text-gray-600 hidden">ì˜ˆë§¤ ìˆ˜: 0</p>
                        <button type="button" onclick="removeChoiceOption(this, '${newId}')" class="text-red-500">X</button>
                    </div>
                `);
            }
        }

        /** ê´€ë¦¬ììš© ì„ íƒí˜• ì˜µì…˜ ì œê±° (ìˆ˜ì • ëª¨ë“œ) */
        window.removeChoiceOption = function(button, choiceId) {
            const optionEl = button.closest('.choice-option');
            if (!editingEventId || !choiceId || optionEl.querySelector('.choice-limit').value === '') {
                // ìƒì„± ëª¨ë“œì—ì„œ ìƒˆë¡œ ë§Œë“  ì˜µì…˜ì´ê±°ë‚˜, ìˆ˜ì • ëª¨ë“œì§€ë§Œ ì•„ì§ DBì— ì €ì¥ë˜ì§€ ì•Šì€ ì˜µì…˜
                optionEl.remove();
                return;
            }
            
            showGlobalModal(true, "ì˜µì…˜ ì‚­ì œ í™•ì¸", 
                `<p>ì´ ì˜µì…˜(${choiceId})ì„ ì‚­ì œí•˜ë©´ ì˜ˆë§¤ì ì¹´ìš´íŠ¸ë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`,
                `<button onclick="confirmRemoveChoiceOption('${choiceId}')" class="p-2 rounded bg-red-600 text-white hover:bg-red-700">ì˜µì…˜ ì‚­ì œ</button>
                 <button onclick="showGlobalModal(false)" class="p-2 rounded bg-gray-300 ml-2">ì·¨ì†Œ</button>`
            );
        }
        
        /** ì„ íƒí˜• ì˜µì…˜ UI ë³€ê²½ ì‹œ í•¸ë“¤ëŸ¬ */
        window.handleAdminTypeChange = function(selectElement) {
            const configEl = document.getElementById('admin-type-config');
            if (!configEl) return;
            
            if (selectElement.value === 'seats') {
                configEl.innerHTML = `
                    <p class="text-sm text-gray-600">ì¢Œì„í˜• ì´ë²¤íŠ¸ëŠ” ìƒì„± ì‹œ ê¸°ë³¸ ì¢Œì„(A1~B10, ì´ 20ê°œ)ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. ì¢Œì„ ë ˆì´ì•„ì›ƒ ë° ì¶”ê°€/ìˆ˜ì •ì€ Firestore ì½˜ì†”ì„ í†µí•´ ì§ì ‘ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                `;
            } else if (selectElement.value === 'choices') {
                configEl.innerHTML = `
                    <div id="choices-container" class="space-y-3">
                        <!-- Options will be added here -->
                    </div>
                    <button type="button" onclick="addChoiceOption()" class="mt-3 p-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 w-full font-semibold">
                        + ì˜µì…˜ ì¶”ê°€
                    </button>
                `;
                // ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ˆë¼ë©´ ê¸°ë³¸ ì˜µì…˜ 1ê°œ ì¶”ê°€
                if (!editingEventId) {
                    addChoiceOption();
                }
            }
        };


        /** ì„ íƒí˜• ì˜µì…˜ ì‚­ì œ í™•ì • */
        window.confirmRemoveChoiceOption = async function(choiceId) {
            showGlobalModal(false);
            showLoading(true, "ì˜µì…˜ ì‚­ì œ ì¤‘...");

            try {
                const choiceRef = firebase.doc(db, COLLECTIONS.events, editingEventId, 'choices', choiceId);
                await firebase.deleteDoc(choiceRef);
                
                // DOMì—ì„œ ì œê±°
                document.querySelector(`.choice-option[data-choice-id="${choiceId}"]`)?.remove();
                
                showMessage(`âœ… ì˜µì…˜ ${choiceId}ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error("Option deletion failed:", error);
                showMessage(`ì˜µì…˜ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        /** ì˜ˆë§¤ ë‚´ì—­ ê°•ì œ ì‚­ì œ ëª¨ë‹¬ í‘œì‹œ */
        window.showAdminBookingSearchModal = function(eventId, eventTitle) {
            showGlobalModal(true, `[${eventTitle}] ì˜ˆë§¤ ê°•ì œ ì‚­ì œ`,
                `<p class="mb-4">ê°•ì œ ì‚­ì œí•  ì˜ˆë§¤ìì˜ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”. í•´ë‹¹ ì˜ˆë§¤(adminBookings)ê°€ ì‚­ì œë˜ê³ , ì¢Œì„/ì„ íƒì§€ ì¹´ìš´íŠ¸ê°€ ë³µêµ¬ë©ë‹ˆë‹¤.</p>
                 <input type="text" id="admin-delete-student-id" placeholder="ì˜ˆë§¤ì í•™ë²ˆ" class="w-full p-2 border rounded-lg mb-4">
                 <p id="admin-delete-error" class="text-red-500 text-sm hidden mb-2"></p>`,
                `<button onclick="adminSearchBooking('${eventId}')" class="p-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">ì¡°íšŒ ë° í™•ì¸</button>
                 <button onclick="showGlobalModal(false)" class="p-2 rounded bg-gray-300 ml-2">ì·¨ì†Œ</button>`,
                'max-w-xl'
            );
        }

        /** ê´€ë¦¬ì ì˜ˆë§¤ ë‚´ì—­ ì¡°íšŒ */
        window.adminSearchBooking = async function(eventId) {
            const studentId = document.getElementById('admin-delete-student-id')?.value.trim();
            const errorEl = document.getElementById('admin-delete-error');
            errorEl?.classList.add('hidden');
            if (!studentId) { if (errorEl) { errorEl.textContent = "í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”."; errorEl.classList.remove('hidden'); } return; }

            showLoading(true, "ì˜ˆë§¤ ë‚´ì—­ ì¡°íšŒ ì¤‘...");

            try {
                const adminBookingRef = firebase.doc(db, COLLECTIONS.adminBookings, eventId + '_' + studentId);
                const snap = await firebase.getDoc(adminBookingRef);

                if (!snap.exists()) {
                    if (errorEl) { errorEl.textContent = "ì¼ì¹˜í•˜ëŠ” ì˜ˆë§¤ ë‚´ì—­(adminBookings)ì´ ì—†ìŠµë‹ˆë‹¤."; errorEl.classList.remove('hidden'); }
                    return;
                }

                const booking = snap.data();
                const bookingId = snap.id; // eventId_studentId
                
                showGlobalModal(true, "ğŸš¨ ì˜ˆë§¤ ê°•ì œ ì‚­ì œ í™•ì¸",
                    `<div class="bg-red-50 p-4 rounded-lg text-left">
                        <p class="font-bold mb-2">ë‹¤ìŒ ì˜ˆë§¤ë¥¼ ê°•ì œë¡œ ì‚­ì œí•©ë‹ˆë‹¤:</p>
                        <p><strong>ì´ë²¤íŠ¸:</strong> ${booking.eventTitle}</p>
                        <p><strong>ì˜ˆë§¤ì:</strong> ${booking.name} (${booking.studentId})</p>
                        <p><strong>ì„ íƒ í•­ëª©:</strong> ${booking.refName} (${booking.type === 'seat' ? 'ì¢Œì„í˜•' : 'ì„ íƒí˜•'})</p>
                        <p class="text-xs text-gray-500">DB ID: ${bookingId}</p>
                    </div>`,
                    `<button onclick="adminDeleteConfirmed('${eventId}', '${booking.type}', '${booking.bookingRefId}', '${booking.studentId}', '${bookingId}')" 
                            class="p-2 rounded bg-red-600 text-white hover:bg-red-700 mt-4">ê°•ì œ ì‚­ì œ ì‹¤í–‰</button>
                     <button onclick="showGlobalModal(false)" class="p-2 rounded bg-gray-300 ml-2 mt-4">ì·¨ì†Œ</button>`,
                    'max-w-xl'
                );

            } catch (error) {
                console.error("Admin Search Error:", error);
                if (errorEl) { errorEl.textContent = `ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`; errorEl.classList.remove('hidden'); }
            } finally {
                showLoading(false);
            }
        }

        /** ê´€ë¦¬ì ì˜ˆë§¤ ë‚´ì—­ ê°•ì œ ì‚­ì œ í™•ì • */
        window.adminDeleteConfirmed = async function(eventId, type, bookingRefId, studentId, bookingId) {
            showGlobalModal(false);
            showLoading(true, "ì˜ˆë§¤ ê°•ì œ ì‚­ì œ ë° ë°ì´í„° ë³µêµ¬ ì¤‘...");

            try {
                await firebase.runTransaction(db, async (transaction) => {
                    // 1. Admin Bookings ì‚­ì œ
                    const adminBookingRef = firebase.doc(db, COLLECTIONS.adminBookings, bookingId);
                    transaction.delete(adminBookingRef);
                    
                    // 3. ì´ë²¤íŠ¸ ìƒíƒœ ë³µêµ¬
                    if (type === 'choice') {
                        // ì„ íƒí˜•: count ê°ì†Œ (bookingRefIdëŠ” choice ID)
                        const choiceRef = firebase.doc(db, COLLECTIONS.events, eventId, 'choices', bookingRefId);
                        transaction.update(choiceRef, { 
                            count: firebase.FieldValue.increment(-1)
                        });
                        
                    } else if (type === 'seat') {
                        // ì¢Œì„í˜•: isBooked í•´ì œ (bookingRefIdëŠ” seat doc ID)
                        const seatRef = firebase.doc(db, COLLECTIONS.events, eventId, 'seats', bookingRefId);
                        transaction.update(seatRef, { 
                            isBooked: false,
                            bookingId: null,
                        });
                    }
                });
                
                showMessage(`âœ… ì˜ˆë§¤ ë‚´ì—­(ID: ${bookingId})ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                // Refresh modal content
                document.getElementById('global-modal')?.classList.add('is-hidden');
                
            } catch (error) {
                console.error("Admin Delete Error:", error);
                showMessage(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // --- Event Listener Setup ---

        /** ì´ë²¤íŠ¸ ëª©ë¡ ì‹¤ì‹œê°„ ë¡œë“œ */
        function setupEventListListener() {
            const eventsCol = firebase.collection(db, COLLECTIONS.events);
            const eventListEl = document.getElementById('event-list');
            
            if (!eventListEl) return;
            
            firebase.onSnapshot(eventsCol, (snapshot) => {
                eventListEl.innerHTML = '';
                if (snapshot.empty) {
                    eventListEl.innerHTML = '<p class="text-center text-gray-500 p-8">í˜„ì¬ ë“±ë¡ëœ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const event = doc.data();
                    const eventId = doc.id;
                    const kstStart = formatKstTime(event.startTime);
                    const status = getBookingStatus(event.startTime, event.endTime);
                    
                    const card = `
                        <div class="kst-card p-6 flex flex-col justify-between" onclick="showEventDetail('${eventId}')">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 mb-2">${event.title}</h3>
                                <p class="text-sm text-gray-600 mb-3">${event.description.substring(0, 50)}${event.description.length > 50 ? '...' : ''}</p>
                            </div>
                            <div>
                                <p class="text-xs text-blue-500 mb-2">ì˜ˆë§¤ ì‹œê°„: ${kstStart}</p>
                                <span class="kst-badge ${status.color}">${status.status}</span>
                            </div>
                        </div>
                    `;
                    eventListEl.insertAdjacentHTML('beforeend', card);
                });
            }, (error) => {
                console.error("Event List Loading Failed:", error);
                eventListEl.innerHTML = '<p class="text-center text-red-500 p-8">ì´ë²¤íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            });
        }

        // --- 10. INITIALIZATION ---
        
        /** Firebase ë° DOM ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” */
        async function initializeFirebase() {
            // 1. DOM ìš”ì†Œ ìºì‹±
            views = {
                list: document.getElementById('event-list-view'),
                detail: document.getElementById('detail-view'),
                booking: document.getElementById('booking-view'),
                admin: document.getElementById('admin-view')
            };

            // 2. Firebase ì´ˆê¸°í™”
            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                showMessage("Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í™˜ê²½ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.", 'error', 10000);
                return;
            }

            // 3. ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ì‚¬ìš©ì ID ì„¤ì •
            await new Promise(resolve => {
                const unsubscribe = firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else if (initialAuthToken) {
                        try {
                            const cred = await firebase.signInWithCustomToken(auth, initialAuthToken);
                            userId = cred.user.uid;
                        } catch (error) {
                            console.error("Custom Token Sign-In Failed:", error);
                            await firebase.signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    } else {
                        await firebase.signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }

                    // ì‚¬ìš©ì IDì— ë”°ë¼ COLLECTIONS.bookings ê²½ë¡œ ì„¤ì •
                    COLLECTIONS.bookings = 'artifacts/' + appId + '/users/' + userId + '/bookings';
                    
                    unsubscribe();
                    resolve();
                });
            });
            
            // 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (DOMì´ ì¤€ë¹„ë˜ì—ˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì¶”ê°€)
            document.getElementById('user-info-form')?.addEventListener('submit', handleUserInfoFormSubmit);
            document.getElementById('check-booking-form')?.addEventListener('submit', handleCheckBookingFormSubmit);
            document.getElementById('create-event-form')?.addEventListener('submit', handleCreateEventFormSubmit);
            document.getElementById('admin-type')?.addEventListener('change', (e) => handleAdminTypeChange(e.target));


            // 5. ì´ˆê¸° ë·° ì„¤ì • ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
            setupEventListListener();
            showEventList(); // ê¸°ë³¸ ë·°ëŠ” ì´ë²¤íŠ¸ ëª©ë¡
        }

        window.addEventListener('load', initializeFirebase);
        
    </script>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center py-4 mb-8 border-b-4 border-emerald-500">
            <h1 class="text-3xl font-extrabold text-gray-800">KST ì˜ˆë§¤ ì‹œìŠ¤í…œ</h1>
            <div class="space-x-2">
                <button onclick="window.toggleAdminView()" class="px-3 py-1 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300">ê´€ë¦¬ì ëª¨ë“œ</button>
            </div>
        </header>

        <!-- 1. Event List View -->
        <div id="event-list-view" class="hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸</h2>
            <div id="event-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Event cards will be inserted here by JavaScript -->
                <p class="text-center text-gray-500 p-8">ì´ë²¤íŠ¸ ëª©ë¡ ë¡œë”© ì¤‘...</p>
            </div>
            
            <!-- My Booking Check Section -->
            <div class="mt-10 p-6 kst-card">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">ë‚˜ì˜ ì˜ˆë§¤ ë‚´ì—­ ì¡°íšŒ ë° ì·¨ì†Œ</h3>
                <form id="check-booking-form" class="space-y-4">
                    <input type="text" id="check-student-id" placeholder="í•™ë²ˆ (ì˜ˆ: 20231234)" required class="w-full p-3 border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    <input type="text" id="check-booking-number" placeholder="ì˜ˆë§¤ ë²ˆí˜¸ (ì¢Œì„ëª… ë˜ëŠ” ì˜µì…˜ ID)" required class="w-full p-3 border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    <p id="check-error-msg" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="w-full p-3 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700">ì˜ˆë§¤ ë‚´ì—­ ì¡°íšŒ</button>
                </form>
                <div id="checked-booking-result" class="hidden mt-4 p-4 border-t border-gray-200">
                    <!-- Booking result and cancel button will be inserted here -->
                </div>
            </div>
        </div>

        <!-- 2. Event Detail and User Info View -->
        <div id="detail-view" class="hidden max-w-xl mx-auto kst-card p-6">
            <h2 id="detail-title" class="text-3xl font-bold mb-4 text-gray-800">ì´ë²¤íŠ¸ ì œëª©</h2>
            <p id="detail-description" class="text-gray-600 mb-4">ì´ë²¤íŠ¸ ìƒì„¸ ì„¤ëª…</p>
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <p class="text-sm font-medium text-gray-700">ì˜ˆë§¤ ê¸°ê°„: <span id="detail-time" class="text-blue-600 font-semibold"></span></p>
                <span id="detail-status" class="kst-badge bg-gray-500">ìƒíƒœ</span>
            </div>
            
            <h3 class="text-xl font-semibold mb-4 text-gray-700">ì˜ˆë§¤ì ì •ë³´ ì…ë ¥</h3>
            <form id="user-info-form" class="space-y-4">
                <input type="text" id="input-name" placeholder="ì´ë¦„" required class="w-full p-3 border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                <input type="text" id="input-student-id" placeholder="í•™ë²ˆ (ì˜ˆ: 20231234)" required class="w-full p-3 border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                <input type="tel" id="input-phone" placeholder="ì „í™”ë²ˆí˜¸ (ì˜ˆ: 010-1234-5678)" required class="w-full p-3 border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                <p id="booking-error-msg" class="text-red-500 text-sm hidden"></p>
                
                <button type="submit" id="start-booking-btn" class="w-full p-3 rounded-lg btn-primary" disabled>
                    ì˜ˆë§¤ ì‹œì‘
                </button>
            </form>
            <button onclick="showEventList()" class="w-full mt-3 p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>

        <!-- 3. Booking View (Seats/Choices) -->
        <div id="booking-view" class="hidden max-w-2xl mx-auto kst-card p-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ì˜ˆë§¤ ì§„í–‰</h2>
            <div class="mb-6 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500 text-sm">
                <p>ì˜ˆë§¤ì: <span id="summary-name" class="font-semibold"></span> (<span id="summary-student-id"></span>)</p>
                <p class="text-xs text-gray-600 mt-1">ì˜ˆë§¤ê°€ ì™„ë£Œë˜ë©´ í•™ë²ˆê³¼ ì„ íƒ í•­ëª©ìœ¼ë¡œ ë‚´ì—­ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div id="booking-content" class="min-h-[200px]">
                <!-- Seats or Choices UI will be rendered here -->
            </div>
            
            <button onclick="showEventList()" class="w-full mt-6 p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                ì˜ˆë§¤ í¬ê¸°/ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>

        <!-- 4. Admin View -->
        <div id="admin-view" class="hidden">
            <div class="flex justify-between items-center mb-6 pb-2 border-b-2 border-orange-500">
                <h2 class="text-2xl font-bold text-orange-700">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                <button onclick="exitAdminView()" class="px-3 py-1 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300">ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ</button>
            </div>

            <!-- Event Creation/Edit Form -->
            <div class="kst-card p-6 mb-8">
                <h3 id="admin-form-mode" class="text-xl font-semibold mb-4 text-gray-700">ìƒˆ ì´ë²¤íŠ¸ ìƒì„± ëª¨ë“œ</h3>
                <form id="create-event-form" class="space-y-4">
                    <input type="text" id="admin-title" placeholder="ì´ë²¤íŠ¸ ì œëª©" required class="w-full p-3 border rounded-lg">
                    <textarea id="admin-description" placeholder="ì´ë²¤íŠ¸ ìƒì„¸ ì„¤ëª…" rows="3" required class="w-full p-3 border rounded-lg"></textarea>
                    
                    <div class="flex gap-4">
                        <label class="block flex-1">
                            <span class="text-sm text-gray-600">ì˜ˆë§¤ ì‹œì‘ ì‹œê° (KST)</span>
                            <input type="datetime-local" id="admin-start-time" required class="w-full p-3 border rounded-lg">
                        </label>
                        <label class="block flex-1">
                            <span class="text-sm text-gray-600">ì˜ˆë§¤ ì¢…ë£Œ ì‹œê° (KST)</span>
                            <input type="datetime-local" id="admin-end-time" required class="w-full p-3 border rounded-lg">
                        </label>
                    </div>

                    <label class="block">
                        <span class="text-sm text-gray-600">ì˜ˆë§¤ ìœ í˜•</span>
                        <select id="admin-type" required onchange="handleAdminTypeChange(this)" class="w-full p-3 border rounded-lg">
                            <option value="choices">ì„ íƒí˜• (ì˜µì…˜ ì„ íƒ, ì„ ì°©ìˆœ)</option>
                            <option value="seats">ì¢Œì„í˜• (ì¢Œì„ ì§€ë„)</option>
                        </select>
                    </label>

                    <div id="admin-type-config" class="p-3 border rounded-lg bg-gray-50">
                        <!-- Type-specific configuration (choices/seats) -->
                    </div>

                    <p id="admin-error-msg" class="text-red-500 text-sm hidden"></p>
                    
                    <div class="flex gap-4 pt-2">
                        <button type="submit" id="create-event-button" class="flex-1 p-3 rounded-lg bg-orange-600 text-white font-bold hover:bg-orange-700">
                            ì´ë²¤íŠ¸ ìƒì„±
                        </button>
                        <button type="button" onclick="resetAdminForm()" class="p-3 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400">
                            ì´ˆê¸°í™”
                        </button>
                    </div>
                </form>
            </div>

            <!-- Event Management List -->
            <div class="kst-card p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">ë“±ë¡ëœ ì´ë²¤íŠ¸ ê´€ë¦¬</h3>
                <div id="admin-event-list" class="space-y-3">
                    <!-- Admin event list will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Global Loading Indicator -->
    <div id="global-loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center space-x-3">
            <svg class="animate-spin h-5 w-5 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-text" class="text-gray-700 font-medium">ì²˜ë¦¬ ì¤‘...</span>
        </div>
    </div>
    
    <!-- Global Modal (Generic Confirmation/Alert) -->
    <div id="global-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[90] is-hidden">
        <div id="global-modal-content" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h3 id="global-modal-title" class="text-xl font-bold mb-4 text-gray-800">ì œëª©</h3>
            <div id="global-modal-body" class="text-gray-700 mb-6">ë‚´ìš©</div>
            <div id="global-modal-buttons" class="space-x-4">ë²„íŠ¼</div>
        </div>
    </div>

    <!-- Queue Modal -->
    <div id="queue-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-[95] is-hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg text-center transform scale-100 animate-pulse-once">
            <h3 class="text-2xl font-bold text-red-600 mb-2">ğŸš¨ ì˜ˆë§¤ ëŒ€ê¸°ì—´ ì§„ì…</h3>
            <p class="text-gray-600 mb-6">ë™ì‹œ ì ‘ì†ì ì´ˆê³¼ë¡œ ì¸í•´ ëŒ€ê¸°ì—´ì— ì§„ì…í–ˆìŠµë‹ˆë‹¤. ì°½ì„ ë‹«ì§€ ë§ê³  ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
            
            <div class="bg-red-100 p-4 rounded-lg mb-6">
                <p class="text-lg font-semibold text-gray-800">í˜„ì¬ ìˆœìœ„: <span id="queue-rank" class="text-2xl text-red-600 font-extrabold">0</span> / <span id="queue-behind">0</span>ëª… ë‚¨ìŒ</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                    <div id="queue-progress" class="bg-green-600 h-2.5 rounded-full transition-all duration-1000" style="width: 100%"></div>
                </div>
            </div>
            
            <p class="text-sm text-gray-500">ìˆœìœ„ê°€ ë˜ë©´ ìë™ìœ¼ë¡œ ì˜ˆë§¤ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- Booking Complete Modal -->
    <div id="complete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[90] is-hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform scale-100 transition-transform">
            <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            <h3 class="text-2xl font-bold text-green-700 mt-3 mb-2">ğŸ‰ ì˜ˆë§¤ ì™„ë£Œ!</h3>
            <p class="text-gray-700 mb-6">ì„±ê³µì ìœ¼ë¡œ ì˜ˆë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            
            <div class="text-left bg-green-50 p-4 rounded-lg border-l-4 border-green-400">
                <p><strong>ì˜ˆë§¤ì:</strong> <span id="complete-name"></span></p>
                <p><strong>í•™ë²ˆ:</strong> <span id="complete-student-id"></span></p>
                <p><strong>ì˜ˆë§¤ ë²ˆí˜¸:</strong> <span id="complete-booking-number" class="text-lg font-bold text-green-600"></span></p>
            </div>
            
            <button onclick="document.getElementById('complete-modal').classList.add('is-hidden'); showEventList();" 
                    class="w-full mt-6 p-3 rounded-lg btn-primary">
                í™•ì¸ ë° ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>
</body>
</html>
