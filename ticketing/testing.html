<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>선착순 예매 시스템</title>

  <!-- Paperlogy 웹폰트 로드 (기존 스타일과 유사) -->
  <link href="https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/Paperlogy.css" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --purple:#7C3AED;
      --grid:#e6e9ef;
      --accent-gradient: linear-gradient(135deg,#f9c74f,#90be6d,#f9844a,#f3722c,#f94144);
      --muted:#6b7280;
      --card:#ffffff;
      --accent:#10b981;
      --danger:#ef4444;
    }
    html,body{height:100%;margin:0;font-family:'Paperlogy',sans-serif;background:#fff;color:#111;box-sizing:border-box;}
    body{display:flex;justify-content:center;align-items:flex-start;padding:24px;}

    /* Desktop container with grid background like original */
    .wrap{
      position:relative;
      width:100%; max-width:1100px; min-height:82vh;
      background:
        linear-gradient(to right, transparent 99px, var(--grid) 100px),
        linear-gradient(to bottom, transparent 99px, var(--grid) 100px);
      background-size:100px 100px;
      border-radius:12px; padding-bottom:120px; box-shadow:0 8px 30px rgba(2,6,23,0.06);
      overflow:hidden;
    }
    .ribbon{
      position:absolute; top:-80px; right:-80px; width:360px; height:360px;
      background:var(--accent-gradient); border-radius:50%; filter:blur(48px) brightness(1.1); opacity:.6;
      transform:rotate(18deg);
    }

    header{
      display:flex; align-items:center; gap:12px; padding:28px 36px;
    }
    .title{font-size:30px; font-weight:900; color:var(--purple);}
    .subtitle{color:var(--muted); font-size:13px;}

    /* Main layout */
    .main{display:flex; gap:20px; padding:18px 36px 36px; flex-wrap:wrap;}
    .left{flex:1 1 520px; min-width:300px;}
    .right{width:360px; min-width:280px;}

    /* Event list (not cardy) — list with rows */
    .event-list{background:transparent; border-radius:8px; overflow:hidden;}
    .event-row{
      display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid #f1f5f9;
      cursor:pointer;
    }
    .event-row:hover{background:#fbfbff;}
    .event-row.selected{background:linear-gradient(90deg, rgba(124,58,237,0.06), rgba(124,58,237,0.02)); outline:2px solid rgba(124,58,237,0.08);}
    .event-name{font-weight:800;}
    .event-meta{font-size:13px; color:var(--muted);}

    /* Right panel */
    .panel{background:var(--card); border-radius:10px; padding:12px; box-shadow:0 6px 20px rgba(2,6,23,0.04);}
    .muted{color:var(--muted); font-size:13px;}

    /* Bottom tabs (modal-like) */
    .bottom-bar{
      position:fixed; left:50%; transform:translateX(-50%); bottom:16px; width:calc(100% - 48px); max-width:820px;
      display:flex; justify-content:space-between; gap:12px; z-index:60;
    }
    .bottom-card{
      flex:1; background:#111827; color:#fff; padding:12px 16px; border-radius:12px; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 6px 24px rgba(2,6,23,0.3);
    }
    .tabs{display:flex; gap:12px; align-items:center;}
    .tab{color:#d1d5db; background:transparent; border:0; cursor:pointer; font-weight:700;}
    .tab.active{color:#fff; text-decoration:underline;}
    .primary{background:linear-gradient(90deg,#7C3AED,#5B21B6); border:0; color:#fff; padding:10px 18px; border-radius:10px; cursor:pointer; font-weight:700;}
    .primary[disabled]{opacity:.45; cursor:not-allowed;}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:120;}
    .modal.active{display:flex;}
    .modal-back{position:absolute; inset:0; background:rgba(0,0,0,0.5);}
    .modal-card{position:relative; width:100%; max-width:920px; max-height:86vh; overflow:auto; border-radius:12px; padding:18px; background:#fff; z-index:121;}

    /* Form elements */
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px;}
    input[type="text"], input[type="tel"], select, textarea{
      width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9ef; box-sizing:border-box; margin-bottom:10px;
    }
    .row{display:flex; gap:8px;}
    .small{font-size:13px;color:var(--muted);}

    /* Seat grid */
    .seat-grid{display:grid; gap:8px; justify-content:center; padding:10px;}
    .seat{width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:6px; cursor:pointer; user-select:none; font-weight:700;}
    .seat.free{background:#f3f4f6;}
    .seat.taken{background:var(--danger); color:#fff; cursor:not-allowed;}
    .seat.selected{background:var(--accent); color:#fff;}

    /* admin layouts */
    .flex-col{display:flex; flex-direction:column; gap:8px;}
    .flex-row{display:flex; gap:8px; align-items:center;}

    /* responsive */
    @media(max-width:900px){
      .main{padding:12px; flex-direction:column;}
      .right{width:100%;}
      .bottom-bar{width:calc(100% - 24px);}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="ribbon"></div>
    <header>
      <div>
        <div class="title">선착순 예매</div>
        <div class="subtitle muted">간단한 티켓팅 / 관리자 포함 · Firebase 기반 실시간 예매</div>
      </div>
      <div style="margin-left:auto" class="muted">관리자키: rrqq23</div>
    </header>

    <div class="main">
      <div class="left">
        <div style="display:flex;justify-content:space-between;align-items:end;margin-bottom:12px;">
          <div style="font-weight:900;font-size:16px;">예매 가능한 이벤트</div>
          <div class="small muted" id="nowTime"></div>
        </div>

        <div class="event-list" id="eventList" role="list"></div>
      </div>

      <div class="right">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div id="selectedTitle" style="font-weight:900">행사를 선택하세요</div>
              <div id="selectedMode" class="muted" style="margin-top:6px"></div>
            </div>
            <div id="selectedMeta" class="muted"></div>
          </div>

          <div id="selectedDesc" class="muted" style="margin-top:12px">행사를 선택하면 상세 정보가 표시됩니다.</div>

          <div style="display:flex; gap:8px; margin-top:14px;">
            <button id="openBooking" class="primary" disabled>예매하기</button>
            <button id="openAdminBtn" class="tab">관리자</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="panel" style="margin-top:12px;">
          <div style="font-weight:800; margin-bottom:6px;">간단 안내</div>
          <div class="small">• 관리자에서 이벤트 생성 및 방식 설정 가능<br>• 개인정보 동의는 privacy.txt에서 로드됨<br>• 선착순은 서버 트랜잭션으로 처리됩니다</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bottom-bar">
    <div class="bottom-card">
      <div class="tabs">
        <button id="tabBooking" class="tab active">예매하기</button>
        <button id="tabMy" class="tab">나의 예매</button>
      </div>
      <div>
        <button id="mainBookBtn" class="primary" disabled>예매하기</button>
      </div>
    </div>
  </div>

  <!-- Booking Modal (flow: consent -> info -> choose -> submit) -->
  <div id="modalBooking" class="modal">
    <div class="modal-back" onclick="closeModal('modalBooking')"></div>
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="font-weight:900" id="mbTitle">예매</div>
        <button class="tab" onclick="closeModal('modalBooking')">✕</button>
      </div>

      <!-- Step 1: consent + info -->
      <div id="mbStep1">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
          <input type="checkbox" id="agreeCheck">
          <label for="agreeCheck" class="small">개인정보 수집 및 이용에 동의합니다. (<a href="#" id="viewPrivacyLink">보기</a>)</label>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>학번 (예: 20901)</label>
            <input type="text" id="inputStudent" placeholder="학번 입력">
            <div class="small">형식: 5자리 숫자, 마지막 두자리는 01~36</div>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>이름</label>
            <input type="text" id="inputName" placeholder="이름">
          </div>
          <div style="flex:1">
            <label>전화번호 (하이픈 없이)</label>
            <input type="tel" id="inputPhone" placeholder="01012345678">
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;">
          <button id="btnNext" class="primary">다음 →</button>
          <button class="tab" onclick="closeModal('modalBooking')">취소</button>
        </div>
      </div>

      <!-- Step 2: booking area (choices or seat) -->
      <div id="mbStep2" style="display:none;">
        <div id="bookingArea"></div>
        <div style="display:flex;gap:8px;margin-top:12px;">
          <button id="btnFinish" class="primary">예매 완료</button>
          <button id="btnBackTo1" class="tab">← 뒤로</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Privacy modal -->
  <div id="modalPrivacy" class="modal">
    <div class="modal-back" onclick="closeModal('modalPrivacy')"></div>
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:900">개인정보 수집 및 이용</div>
        <button class="tab" onclick="closeModal('modalPrivacy')">✕</button>
      </div>
      <div id="privacyContent" style="margin-top:12px; white-space:pre-wrap; color:var(--muted); max-height:60vh; overflow:auto;"></div>
    </div>
  </div>

  <!-- My booking modal -->
  <div id="modalMy" class="modal">
    <div class="modal-back" onclick="closeModal('modalMy')"></div>
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:900">나의 예매 확인</div>
        <button class="tab" onclick="closeModal('modalMy')">✕</button>
      </div>
      <div style="margin-top:12px;">
        <label>학번</label>
        <input type="text" id="myStudent">
        <label>예매번호</label>
        <input type="text" id="myBookingId">
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="btnMyCheck" class="primary">조회</button>
          <button onclick="closeModal('modalMy')" class="tab">닫기</button>
        </div>
        <div id="myResult" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Admin modal -->
  <div id="modalAdmin" class="modal">
    <div class="modal-back" onclick="closeModal('modalAdmin')"></div>
    <div class="modal-card" style="max-width:1100px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:900">관리자 모드</div>
        <button class="tab" onclick="closeModal('modalAdmin')">✕</button>
      </div>

      <div style="display:flex;gap:12px; margin-top:12px; flex-wrap:wrap;">
        <!-- left: event list -->
        <div style="flex:1; min-width:300px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-weight:800">이벤트 목록</div>
            <div>
              <button id="btnNewEvent" class="primary" style="background:linear-gradient(90deg,#06b6d4,#7c3aed)">새 이벤트</button>
            </div>
          </div>
          <div id="adminEventList" style="margin-top:8px; max-height:420px; overflow:auto; border:1px solid #f1f5f9; border-radius:8px;"></div>
        </div>

        <!-- right: editor -->
        <div style="flex:1.2; min-width:360px;">
          <div style="font-weight:800">이벤트 편집</div>
          <form id="eventForm" style="margin-top:8px;">
            <input type="hidden" id="evtId">
            <label>이름</label>
            <input type="text" id="evtName">
            <label>설명</label>
            <input type="text" id="evtDesc">
            <label>예매 방식</label>
            <select id="evtMode">
              <option value="choices">선택지형</option>
              <option value="seats">좌석형</option>
            </select>

            <div id="choicesArea" style="margin-top:8px;">
              <div style="display:flex;gap:8px;">
                <input id="optName" placeholder="옵션명">
                <input id="optLimit" placeholder="인원" style="width:88px;">
                <button type="button" id="addOpt" class="tab">추가</button>
              </div>
              <div id="optList" style="margin-top:8px;"></div>
            </div>

            <div id="seatsArea" style="margin-top:8px; display:none;">
              <label>행(Row)</label>
              <input id="seatRows" type="number" min="1" value="5">
              <label>열(Col)</label>
              <input id="seatCols" type="number" min="1" value="8">
              <div style="margin-top:8px;">
                <button type="button" id="genSeats" class="tab">좌석 생성</button>
              </div>
              <div id="seatPreview" style="margin-top:8px;"></div>
            </div>

            <label style="margin-top:8px">예매 시작 (ISO)</label>
            <input id="evtStart" placeholder="YYYY-MM-DDTHH:MM" />
            <label>예매 종료 (ISO)</label>
            <input id="evtEnd" placeholder="YYYY-MM-DDTHH:MM" />

            <div style="display:flex;gap:8px;margin-top:10px;">
              <button id="saveEvent" type="button" class="primary">저장</button>
              <button id="delEvent" type="button" class="tab">삭제</button>
            </div>
          </form>
        </div>
      </div>

      <!-- bookings -->
      <div style="margin-top:12px;">
        <div style="font-weight:800; margin-bottom:8px;">예매자 목록</div>
        <div id="adminBookings" style="max-height:180px;overflow:auto;border:1px solid #f1f5f9;border-radius:8px;padding:8px;"></div>
      </div>
    </div>
  </div>

<script>
  // Firebase config (user provided)
  const firebaseConfig = {
    apiKey: "AIzaSyCfgFrqqwTDssY11-Z1Ti1pNMSSWJIHA_Q",
    authDomain: "report209-16824.firebaseapp.com",
    projectId: "report209-16824",
    storageBucket: "report209-16824.firebasestorage.app",
    messagingSenderId: "45258886547",
    appId: "1:45258886547:web:3589999076939b8f58ec66",
    measurementId: "G-RRBM6LHGSY"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Utilities
  const $ = id => document.getElementById(id);
  const nowTime = $('nowTime');
  setInterval(()=> nowTime.textContent = new Date().toLocaleString(), 1000);
  nowTime.textContent = new Date().toLocaleString();

  // State
  let eventsCache = [];
  let selectedEvent = null;
  let flow = { student:'', name:'', phone:'', bookingData:null };

  // Elements
  const eventListEl = $('eventList');
  const openBookingBtn = $('openBooking');
  const mainBookBtn = $('mainBookBtn');

  // Tabs
  const tabBooking = $('tabBooking'), tabMy = $('tabMy');

  // Modal control
  function openModal(id){ $(id).classList.add('active'); }
  function closeModal(id){ $(id).classList.remove('active'); }

  // Load privacy text
  fetch('privacy.txt').then(r=> r.ok ? r.text() : Promise.resolve('개인정보 수집 이용 동의 내용이 없습니다.')).then(t => {
    $('privacyContent').textContent = t;
  });

  // REALTIME: listen events collection
  function subscribeEvents(){
    db.collection('events').orderBy('createdAt','desc').onSnapshot(snap=>{
      eventsCache = [];
      eventListEl.innerHTML = '';
      snap.forEach(doc=>{
        const d = { id: doc.id, ...doc.data() };
        eventsCache.push(d);
        const row = document.createElement('div');
        row.className = 'event-row';
        row.dataset.id = doc.id;
        row.innerHTML = `<div><div class="event-name">${escape(d.name)}</div><div class="event-meta">${escape(d.desc||'')}</div></div>
                         <div class="muted">${d.mode==='seats'?'좌석형':'선택지형'} • ${d.start?('시작:'+(new Date(d.start).toLocaleString())):''}</div>`;
        row.onclick = ()=> selectEvent(d.id);
        eventListEl.appendChild(row);
      });
      // update selection highlight if needed
      if(selectedEvent) highlightSelected();
    }, err => console.error(err));
  }

  function highlightSelected(){
    document.querySelectorAll('.event-row').forEach(r=> r.classList.toggle('selected', r.dataset.id===selectedEvent?.id));
    if(selectedEvent){
      $('selectedTitle').textContent = selectedEvent.name;
      $('selectedMode').textContent = selectedEvent.mode==='seats' ? '좌석 예매형' : '선택지 예매형';
      $('selectedDesc').textContent = selectedEvent.desc || '';
      openBookingBtn.disabled = false;
      mainBookBtn.disabled = false;
    } else {
      $('selectedTitle').textContent = '행사를 선택하세요';
      $('selectedMode').textContent = '';
      $('selectedDesc').textContent = '행사를 선택하면 상세 정보가 표시됩니다.';
      openBookingBtn.disabled = true;
      mainBookBtn.disabled = true;
    }
  }

  function selectEvent(id){
    selectedEvent = eventsCache.find(e=>e.id===id);
    highlightSelected();
  }

  // Booking flow: open modal and step handling
  openBookingBtn.addEventListener('click', ()=> {
    if(!selectedEvent) { alert('행사를 선택하세요.'); return; }
    flow = { student:'', name:'', phone:'', bookingData:null };
    $('mbTitle').textContent = `예매 - ${selectedEvent.name}`;
    $('mbStep1').style.display = 'block';
    $('mbStep2').style.display = 'none';
    $('agreeCheck').checked = false;
    $('inputStudent').value = '';
    $('inputName').value = '';
    $('inputPhone').value = '';
    openModal('modalBooking');
  });
  mainBookBtn.addEventListener('click', ()=> openBookingBtn.click());

  // privacy link in booking modal
  $('viewPrivacyLink').addEventListener('click', (e)=>{
    e.preventDefault();
    openModal('modalPrivacy');
  });

  // Step1 -> validate and duplicate check
  $('btnNext').addEventListener('click', async ()=>{
    const agree = $('agreeCheck').checked;
    const student = $('inputStudent').value.trim();
    const name = $('inputName').value.trim();
    const phone = $('inputPhone').value.trim();
    if(!agree) return alert('개인정보 동의가 필요합니다.');
    if(!student || !name || !phone) return alert('모든 항목을 입력하세요.');
    // Student format: 5 digits, last two between 01 and 36
    if(!/^\d{5}$/.test(student)) return alert('학번은 5자리 숫자여야 합니다.');
    const lastTwo = parseInt(student.slice(-2), 10);
    if(lastTwo < 1 || lastTwo > 36) return alert('학번 마지막 두 자리는 01~36 사이여야 합니다.');
    if(!/^\d{8,12}$/.test(phone)) return alert('전화번호는 하이픈 없이 숫자로 입력하세요.');

    // Duplicate check (student OR phone)
    const dupByStudent = await db.collection('bookings').where('student', '==', student).get();
    const dupByPhone = await db.collection('bookings').where('phone','==', phone).get();
    if(!dupByStudent.empty || !dupByPhone.empty) return alert('이미 등록된 학번 또는 전화번호가 존재합니다.');

    // Save to flow and show booking UI
    flow.student = student; flow.name = name; flow.phone = phone;
    renderBookingArea();
    $('mbStep1').style.display = 'none';
    $('mbStep2').style.display = 'block';
  });

  $('btnBackTo1').addEventListener('click', ()=>{
    $('mbStep2').style.display = 'none'; $('mbStep1').style.display = 'block';
  });

  // Render booking area (choice or seats)
  async function renderBookingArea(){
    const area = $('bookingArea');
    area.innerHTML = '';
    const evDoc = await db.collection('events').doc(selectedEvent.id).get();
    if(!evDoc.exists) { area.textContent = '이벤트 정보를 찾을 수 없습니다.'; return; }
    const ev = evDoc.data();

    // Check time window
    const now = new Date();
    if(ev.start && new Date(ev.start) > now){ area.innerHTML = '<div class="small">예매가 아직 시작되지 않았습니다.</div>'; return; }
    if(ev.end && new Date(ev.end) < now){ area.innerHTML = '<div class="small">예매 기간이 종료되었습니다.</div>'; return; }

    if(ev.mode === 'choices'){
      const title = document.createElement('div'); title.style.fontWeight=800; title.textContent='옵션을 선택하세요'; area.appendChild(title);
      const optsSnap = await db.collection('events').doc(selectedEvent.id).collection('options').orderBy('createdAt','asc').get();
      optsSnap.forEach(doc=>{
        const o = { id: doc.id, ...doc.data() };
        const row = document.createElement('div'); row.className='flex-row'; row.style.justifyContent='space-between';
        row.style.padding='10px'; row.style.border='1px solid #f1f5f9'; row.style.borderRadius='8px'; row.style.marginTop='8px';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${escape(o.name)}</div><div class="small">잔여 ${Math.max(0,(o.limit - (o.count||0)))} / ${o.limit}</div>`;
        const btn = document.createElement('button'); btn.className='primary'; btn.textContent='선택';
        if((o.count||0) >= o.limit) btn.disabled = true;
        btn.onclick = ()=> {
          // set chosen option in flow.bookingData
          flow.bookingData = { type:'choice', optionId:o.id, optionName:o.name };
          // visual select
          document.querySelectorAll('#bookingArea .selected-row').forEach(el=>el.classList.remove('selected-row'));
          row.classList.add('selected-row');
        };
        row.appendChild(left); row.appendChild(btn);
        area.appendChild(row);
      });

    } else if(ev.mode === 'seats'){
      const title = document.createElement('div'); title.style.fontWeight=800; title.textContent='좌석을 선택하세요'; area.appendChild(title);

      // fetch seats
      const seatsSnap = await db.collection('events').doc(selectedEvent.id).collection('seats').get();
      const seats = seatsSnap.docs.map(d=> ({ id:d.id, ...d.data() }) );
      // determine grid dimensions
      const maxRow = Math.max(...seats.map(s=>s.row),1);
      const maxCol = Math.max(...seats.map(s=>s.col),1);
      const grid = document.createElement('div');
      grid.className='seat-grid';
      grid.style.gridTemplateColumns = `repeat(${maxCol}, 46px)`;
      grid.style.marginTop = '8px';

      seats.forEach(s=>{
        const btn = document.createElement('div');
        btn.className = 'seat ' + (s.reserved ? 'taken' : 'free');
        btn.textContent = s.label;
        if(!s.reserved){
          btn.onclick = ()=> {
            // deselect previous
            grid.querySelectorAll('.seat').forEach(el=> el.classList.remove('selected'));
            btn.classList.add('selected');
            flow.bookingData = { type:'seat', seatId:s.id, seatLabel:s.label };
          };
        }
        grid.appendChild(btn);
      });
      area.appendChild(grid);
      const hint = document.createElement('div'); hint.className='small'; hint.style.marginTop='8px'; hint.textContent='좌석을 선택한 뒤 예매 완료를 눌러주세요.';
      area.appendChild(hint);
    }
  }

  // Finish booking: transaction-safe
  $('btnFinish').addEventListener('click', async ()=>{
    if(!flow.bookingData) return alert('옵션 또는 좌석을 선택하세요.');
    try{
      if(flow.bookingData.type === 'choice'){
        // transaction: increment option count and create booking doc
        const optionRef = db.collection('events').doc(selectedEvent.id).collection('options').doc(flow.bookingData.optionId);
        await db.runTransaction(async t => {
          const optDoc = await t.get(optionRef);
          if(!optDoc.exists) throw new Error('옵션이 존재하지 않습니다.');
          const data = optDoc.data();
          const cur = data.count || 0;
          if(cur >= data.limit) throw new Error('잔여 인원이 없습니다.');
          t.update(optionRef, { count: cur + 1 });
          const bookingRef = db.collection('bookings').doc();
          t.set(bookingRef, {
            eventId: selectedEvent.id,
            eventName: selectedEvent.name,
            student: flow.student, name: flow.name, phone: flow.phone,
            type:'choice',
            optionId: flow.bookingData.optionId,
            optionName: flow.bookingData.optionName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
      } else {
        // seat reserve: transaction mark seat reserved and create booking
        const seatRef = db.collection('events').doc(selectedEvent.id).collection('seats').doc(flow.bookingData.seatId);
        await db.runTransaction(async t => {
          const seatDoc = await t.get(seatRef);
          if(!seatDoc.exists) throw new Error('좌석 정보 없음');
          const data = seatDoc.data();
          if(data.reserved) throw new Error('이미 예약된 좌석입니다.');
          t.update(seatRef, { reserved: true });
          const bookingRef = db.collection('bookings').doc();
          t.set(bookingRef, {
            eventId: selectedEvent.id,
            eventName: selectedEvent.name,
            student: flow.student, name: flow.name, phone: flow.phone,
            type:'seat',
            seatId: flow.bookingData.seatId,
            seatLabel: flow.bookingData.seatLabel,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
      }

      // success
      alert('예매 완료되었습니다.');
      closeModal('modalBooking');
    }catch(err){
      alert('예매 실패: ' + (err.message || err));
    }
  });

  /* ----------------- "나의 예매" 기능 ----------------- */
  $('tabMy').addEventListener('click', ()=> openModal('modalMy'));
  $('tabBooking').addEventListener('click', ()=> {
    // close My if open
    closeModal('modalMy');
  });

  $('btnMyCheck').addEventListener('click', async ()=>{
    const student = $('myStudent').value.trim();
    const bookingId = $('myBookingId').value.trim();
    if(!student || !bookingId) return alert('학번과 예매번호를 입력하세요.');
    const doc = await db.collection('bookings').doc(bookingId).get();
    const result = $('myResult');
    result.innerHTML = '';
    if(!doc.exists) return result.textContent = '일치하는 예매정보가 없습니다.';
    const b = doc.data();
    if(b.student !== student) return result.textContent = '학번과 예매번호가 일치하지 않습니다.';
    result.innerHTML = `<div style="font-weight:800">${escape(b.eventName)}</div><div class="small">이름: ${escape(b.name)} / 전화: ${escape(b.phone)}</div><div class="small">타입: ${escape(b.type)}</div>`;
  });

  /* ----------------- Admin mode (rrqq23) ----------------- */
  let keyBuffer = '';
  window.addEventListener('keydown', (e)=>{
    keyBuffer += e.key;
    if(keyBuffer.length > 12) keyBuffer = keyBuffer.slice(-12);
    if(keyBuffer.includes('rrqq23')){
      openModal('modalAdmin');
      renderAdmin();
      keyBuffer = '';
    }
  });

  // ADMIN: list events & bookings, create/edit events, manage options/seats
  async function renderAdmin(){
    // events
    const list = $('adminEventList');
    list.innerHTML = '';
    const snap = await db.collection('events').orderBy('createdAt','desc').get();
    snap.forEach(doc=>{
      const d = { id: doc.id, ...doc.data() };
      const el = document.createElement('div');
      el.style.padding='8px'; el.style.borderBottom='1px solid #f1f5f9';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${escape(d.name)}</strong><div class="small">${escape(d.desc||'')}</div></div>
        <div>
          <button class="tab" onclick="loadEventToForm('${d.id}')">편집</button>
        </div>
      </div>`;
      list.appendChild(el);
    });

    // bookings
    const bkDiv = $('adminBookings'); bkDiv.innerHTML = '';
    const bkSnap = await db.collection('bookings').orderBy('timestamp','desc').get();
    bkSnap.forEach(doc=>{
      const b = doc.data();
      const row = document.createElement('div'); row.style.padding='6px'; row.style.borderBottom='1px solid #f1f5f9';
      row.innerHTML = `<div><strong>${escape(b.eventName||'')}</strong> - ${escape(b.name)} (${escape(b.student)}) <button class="tab" onclick="adminDeleteBooking('${doc.id}')">삭제</button></div>`;
      bkDiv.appendChild(row);
    });
  }

  // expose admin functions to window
  window.loadEventToForm = async function(id){
    const evDoc = await db.collection('events').doc(id).get();
    if(!evDoc.exists) return alert('이벤트 없음');
    const d = evDoc.data();
    $('evtId').value = id;
    $('evtName').value = d.name || '';
    $('evtDesc').value = d.desc || '';
    $('evtMode').value = d.mode || 'choices';
    $('evtStart').value = d.start || '';
    $('evtEnd').value = d.end || '';
    // populate options or seats
    if(d.mode === 'choices'){
      $('choicesArea').style.display='block'; $('seatsArea').style.display='none';
      const optList = $('optList'); optList.innerHTML = '';
      const optSnap = await db.collection('events').doc(id).collection('options').orderBy('createdAt','asc').get();
      optSnap.forEach(doc => {
        const o = doc.data(); const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
        row.innerHTML = `<div>${escape(o.name)} (인원:${o.limit})</div><div><button class="tab" onclick="removeOpt('${id}','${doc.id}')">삭제</button></div>`;
        optList.appendChild(row);
      });
    } else {
      $('choicesArea').style.display='none'; $('seatsArea').style.display='block';
      $('seatPreview').innerHTML = '';
      // show small preview of seats
      const seatsSnap = await db.collection('events').doc(id).collection('seats').get();
      const seats = seatsSnap.docs.map(d => d.data());
      const r = Math.max(...seats.map(s=>s.row),1), c = Math.max(...seats.map(s=>s.col),1);
      const preview = document.createElement('div'); preview.style.display='grid'; preview.style.gridTemplateColumns = `repeat(${c},24px)`; preview.style.gap='4px';
      seats.forEach(s=>{ const b=document.createElement('div'); b.style.width='24px'; b.style.height='24px'; b.style.background=s.reserved?'#ef4444':'#a7f3d0'; preview.appendChild(b); });
      $('seatPreview').appendChild(preview);
      $('seatRows').value = r; $('seatCols').value = c;
    }
  };

  // new event
  $('btnNewEvent').addEventListener('click', ()=>{
    $('evtId').value=''; $('evtName').value=''; $('evtDesc').value=''; $('evtMode').value='choices';
    $('optList').innerHTML=''; $('seatPreview').innerHTML=''; $('seatRows').value=5; $('seatCols').value=8;
    $('choicesArea').style.display='block'; $('seatsArea').style.display='none';
  });

  // mode change
  $('evtMode').addEventListener('change', (e)=>{
    if(e.target.value==='choices'){ $('choicesArea').style.display='block'; $('seatsArea').style.display='none'; } else { $('choicesArea').style.display='none'; $('seatsArea').style.display='block'; }
  });

  // add option
  $('addOpt').addEventListener('click', ()=>{
    const name = $('optName').value.trim(); const limit = parseInt($('optLimit').value,10)||0;
    if(!name || limit<=0) return alert('옵션명과 인원을 입력하세요.');
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
    row.innerHTML = `<div>${escape(name)} (인원:${limit})</div><div><button class="tab" onclick="this.closest('div').remove()">삭제</button></div>`;
    row.dataset.name = name; row.dataset.limit = limit;
    $('optList').appendChild(row);
    $('optName').value=''; $('optLimit').value='';
  });

  // generate seats preview
  $('genSeats').addEventListener('click', ()=>{
    const r = parseInt($('seatRows').value,10)||0; const c = parseInt($('seatCols').value,10)||0;
    if(r<=0||c<=0) return alert('행/열을 올바르게 입력하세요.');
    const preview = $('seatPreview'); preview.innerHTML='';
    const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns = `repeat(${c},24px)`; grid.style.gap='6px';
    for(let i=1;i<=r;i++){
      for(let j=1;j<=c;j++){
        const cell = document.createElement('div'); cell.style.width='24px'; cell.style.height='24px'; cell.style.background='#f3f4f6'; cell.style.borderRadius='4px';
        grid.appendChild(cell);
      }
    }
    preview.appendChild(grid);
  });

  // save event (create or update)
  $('saveEvent').addEventListener('click', async ()=>{
    const id = $('evtId').value || null;
    const name = $('evtName').value.trim(); const desc = $('evtDesc').value.trim();
    const mode = $('evtMode').value;
    const start = $('evtStart').value.trim() || null; const end = $('evtEnd').value.trim() || null;
    if(!name) return alert('이벤트명을 입력하세요.');
    if(!id){
      // create
      const docRef = db.collection('events').doc();
      await docRef.set({ name, desc, mode, start, end, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      if(mode==='choices'){
        // save options from UI
        const rows = $('optList').children;
        for(const r of rows){
          await docRef.collection('options').doc().set({ name: r.dataset.name, limit: parseInt(r.dataset.limit,10), count:0, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
      } else {
        // seats generation
        const r = parseInt($('seatRows').value,10), c = parseInt($('seatCols').value,10);
        for(let i=1;i<=r;i++){
          for(let j=1;j<=c;j++){
            const label = String.fromCharCode(64+i) + j;
            await docRef.collection('seats').doc().set({ row:i, col:j, label, reserved:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          }
        }
      }
      alert('이벤트 생성 완료');
    } else {
      // update basic fields
      const docRef = db.collection('events').doc(id);
      await docRef.update({ name, desc, mode, start, end });
      // if choices: replace options (simple approach: delete all existing and add UI ones)
      if(mode==='choices'){
        const optSnap = await docRef.collection('options').get();
        for(const od of optSnap.docs) await od.ref.delete();
        const rows = $('optList').children;
        for(const r of rows){
          await docRef.collection('options').doc().set({ name: r.dataset.name, limit: parseInt(r.dataset.limit,10), count:0, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
      } else {
        // seats: regenerate if size changed (for simplicity we'll clear and regenerate)
        const r = parseInt($('seatRows').value,10), c = parseInt($('seatCols').value,10);
        // delete existing seats
        const seatSnap = await docRef.collection('seats').get();
        for(const sd of seatSnap.docs) await sd.ref.delete();
        for(let i=1;i<=r;i++){
          for(let j=1;j<=c;j++){
            const label = String.fromCharCode(64+i) + j;
            await docRef.collection('seats').doc().set({ row:i, col:j, label, reserved:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          }
        }
      }
      alert('이벤트 업데이트 완료');
    }
    renderAdmin();
  });

  // delete event
  $('delEvent').addEventListener('click', async ()=>{
    const id = $('evtId').value;
    if(!id) return alert('삭제할 이벤트를 선택하세요.');
    if(!confirm('정말 삭제하시겠습니까? 이벤트와 관련 예매도 모두 삭제됩니다.')) return;
    // delete bookings for event
    const bksSnap = await db.collection('bookings').where('eventId','==',id).get();
    for(const b of bksSnap.docs) await b.ref.delete();
    // delete subcollections (options/seats)
    const optSnap = await db.collection('events').doc(id).collection('options').get();
    for(const od of optSnap.docs) await od.ref.delete();
    const seatSnap = await db.collection('events').doc(id).collection('seats').get();
    for(const sd of seatSnap.docs) await sd.ref.delete();
    // delete event doc
    await db.collection('events').doc(id).delete();
    alert('삭제 완료');
    $('evtId').value=''; $('evtName').value=''; $('optList').innerHTML=''; $('seatPreview').innerHTML='';
    renderAdmin();
  });

  // remove single option (admin)
  window.removeOpt = async function(eventId, optId){
    if(!confirm('옵션을 삭제하면 해당 옵션의 예매자도 삭제됩니다. 계속할까요?')) return;
    // delete bookings referencing this option
    const bkSnap = await db.collection('bookings').where('eventId','==',eventId).where('optionId','==',optId).get();
    for(const b of bkSnap.docs){
      await b.ref.delete();
    }
    await db.collection('events').doc(eventId).collection('options').doc(optId).delete();
    renderAdmin();
  };

  // admin delete booking
  window.adminDeleteBooking = async function(id){
    if(!confirm('예매를 삭제하면 좌석/카운트가 복구됩니다. 계속할까요?')) return;
    const doc = await db.collection('bookings').doc(id).get();
    if(!doc.exists) return alert('해당 예매 없음');
    const data = doc.data();
    // reverse effects
    if(data.type === 'choice' && data.optionId){
      // decrement option count safely
      const optRef = db.collection('events').doc(data.eventId).collection('options').doc(data.optionId);
      await db.runTransaction(async t=>{
        const od = await t.get(optRef);
        if(od.exists){
          const cnt = od.data().count || 0;
          t.update(optRef, { count: Math.max(0,cnt-1) });
        }
        t.delete(db.collection('bookings').doc(id));
      });
    } else if(data.type==='seat' && data.seatId){
      const seatRef = db.collection('events').doc(data.eventId).collection('seats').doc(data.seatId);
      await db.runTransaction(async t=>{
        t.update(seatRef, { reserved: false });
        t.delete(db.collection('bookings').doc(id));
      });
    } else {
      await db.collection('bookings').doc(id).delete();
    }
    alert('예매 삭제 완료');
    renderAdmin();
  };

  // initial subscriptions
  subscribeEvents();

  // Admin render initial
  // (called when modal opens)
  // renderAdmin();

  // helper escape
  function escape(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // expose some for console/test
  window.openModal = openModal; window.closeModal = closeModal;
</script>
</body>
</html>
